<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Sandbox low-level-policy | Focu$ on yourself.</title><meta name="description" content="Chromium low-level-policy浅析。"><meta name="keywords" content="Chromium"><meta name="author" content="0xfocu5"><meta name="copyright" content="0xfocu5"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="shortcut icon" href="https://focu5.oss-accelerate.aliyuncs.com/blog/20200927102719.jpg"><link rel="canonical" href="https://0xfocu5.github.io/posts/28399a6/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Sandbox low-level-policy"><meta property="og:url" content="https://0xfocu5.github.io/posts/28399a6/"><meta property="og:site_name" content="Focu$ on yourself."><meta property="og:description" content="Chromium low-level-policy浅析。"><meta property="og:image" content="https://focu5.oss-accelerate.aliyuncs.com/blog/20200927102719.jpg"><meta property="article:published_time" content="2021-08-01T16:00:00.000Z"><meta property="article:modified_time" content="2021-08-13T03:06:50.163Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Snackbar.bookmark.message_prev',
    message_next: 'Snackbar.bookmark.message_next'
  },
  runtime: 'days',
  date_suffix: {"one_hour":"date_suffix.one_hour","hours":"date_suffix.hours","day":"天前"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
    },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-08-13 11:06:50'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
  }
}

var autoChangeMode = 'false'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="https://focu5.oss-cn-beijing.aliyuncs.com/img/20200714224051.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">21</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">12</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">16</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tages</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Opcode"><span class="toc-number">1.</span> <span class="toc-text">Opcode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Opcode-1"><span class="toc-number">1.1.</span> <span class="toc-text">Opcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OpcodeID"><span class="toc-number">1.1.1.</span> <span class="toc-text">OpcodeID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Opcode-Options"><span class="toc-number">1.1.2.</span> <span class="toc-text">Opcode Options</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Comparison-opcode"><span class="toc-number">1.1.3.</span> <span class="toc-text">Comparison opcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Action-opcode"><span class="toc-number">1.1.4.</span> <span class="toc-text">Action opcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Policyopcde"><span class="toc-number">1.2.</span> <span class="toc-text">Policyopcde</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PolicyOpcode-Evaluate"><span class="toc-number">1.2.1.</span> <span class="toc-text">PolicyOpcode::Evaluate()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OPCODE-EVAL"><span class="toc-number">1.2.2.</span> <span class="toc-text">OPCODE_EVAL()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpcodeFactory"><span class="toc-number">1.3.</span> <span class="toc-text">OpcodeFactory</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Filesystem"><span class="toc-number">2.</span> <span class="toc-text">Filesystem</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FileSystemPolicy-GenerateRules"><span class="toc-number">2.1.</span> <span class="toc-text">FileSystemPolicy::GenerateRules</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FileSystemPolicy-SetInitialRules"><span class="toc-number">2.2.</span> <span class="toc-text">FileSystemPolicy::SetInitialRules()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">2.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#edge-sandbox"><span class="toc-number">3.</span> <span class="toc-text">edge:&#x2F;&#x2F;sandbox</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GetPolicyRules"><span class="toc-number">3.1.</span> <span class="toc-text">GetPolicyRules</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GetPolicyOpcodes"><span class="toc-number">3.2.</span> <span class="toc-text">GetPolicyOpcodes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GetPolicyOpcode"><span class="toc-number">3.3.</span> <span class="toc-text">GetPolicyOpcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GetStringMatchOperation"><span class="toc-number">3.4.</span> <span class="toc-text">GetStringMatchOperation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StringMatchOptions"><span class="toc-number">3.5.</span> <span class="toc-text">StringMatchOptions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="toc-number">3.6.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://focu5.oss-accelerate.aliyuncs.com/blog/20200927102719.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Focu$ on yourself.</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tages</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Sandbox low-level-policy</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-08-01T16:00:00.000Z" title="发表于 2021-08-02 00:00:00">2021-08-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-08-13T03:06:50.163Z" title="更新于 2021-08-13 11:06:50">2021-08-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Chromium/">Chromium</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Chromium/policy/">policy</a></span></div><div class="meta-secondline"> </div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Opcode"><a href="#Opcode" class="headerlink" title="Opcode"></a>Opcode</h1><h2 id="Opcode-1"><a href="#Opcode-1" class="headerlink" title="Opcode"></a>Opcode</h2><p>低级策略(low-level-policy)是使用策略“操作码”的概念实现的。操作码是一种包含足够信息的结构，可以对单个输入参数执行一次比较，下面给出了几个比较的范例：</p>
<ul>
<li>Is input parameter 3 not equal to nullptr?</li>
<li>Does input parameter 2 start with L”c:\“?</li>
<li>Is input parameter 5, bit 3 is equal 1?</li>
</ul>
<p>每个操作码实际上相当于一个函数调用，但操作码知道原函数的参数的个数是 原函数的参数个数-1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bool fn(a, b, c, d)  with 4 arguments</span><br><span class="line">Then an opcode is: op(fn, b, c, d)</span><br><span class="line"></span><br><span class="line">关于操作码评估：</span><br><span class="line">op.eval(a)  ------------------------&gt; fn(a,b,c,d)</span><br><span class="line">                internally calls</span><br><span class="line">                </span><br><span class="line">评估是在具有N个比较操作码加1个动作操作码的操作码组中进行的。 </span><br><span class="line"></span><br><span class="line">[comparison 1][comparison 2]...[comparison N][action][comparison 1]...</span><br><span class="line">	   ----- evaluation order-----------&gt;</span><br></pre></td></tr></table></figure>

<p>每个操作码组编码一个高级策略规则。仅当组上的所有条件计算为true时，该规则才适用。操作操作码包含该特定规则的策略结果。</p>
<p>关于 opcode：</p>
<ul>
<li>每个 opcode 都有其对应的Options，这些Options在创建 opcode 的时候就已经被指定。</li>
<li>每个 opcode 由：opcodeID、 一个index索引表示哪个是输入参数、一个参数数组三部分组成。</li>
<li>opcode 由 borker 进程中生成的，并作为原始内存复制到目标进程</li>
<li>一个opcode组由N个comparison opcodes加上一个action opcode组成</li>
</ul>
<h3 id="OpcodeID"><a href="#OpcodeID" class="headerlink" title="OpcodeID"></a>OpcodeID</h3><p>以下是已实现的操作码。</p>
<ul>
<li><p><strong>OP_ALWAYS_FALSE：</strong> Evaluates to false (EVAL_FALSE).</p>
</li>
<li><p><strong>OP_ALWAYS_TRUE：</strong> Evaluates to true (EVAL_TRUE).</p>
</li>
<li><p><strong>OP_NUMBER_MATCH：</strong>Match a 32-bit integer as n == a.</p>
</li>
<li><p><strong>OP_NUMBER_MATCH_RANGE：</strong>Match a 32-bit integer as a &lt;= n &lt;= b.</p>
</li>
<li><p><strong>OP_NUMBER_AND_MATCH：</strong>Match using bitwise AND; as in: n &amp; a != 0.</p>
</li>
<li><p><strong>OP_WSTRING_MATCH：</strong>Match a string for equality.</p>
</li>
<li><p><strong>OP_ACTION：</strong>Evaluates to an action opcode.</p>
</li>
</ul>
<h3 id="Opcode-Options"><a href="#Opcode-Options" class="headerlink" title="Opcode Options"></a>Opcode Options</h3><p>适用于每个操作码的选项。它们在使用OpcodeFactory::MakeOpXXXXX()函数族创建每个操作码时指定。</p>
<ul>
<li><strong>const uint32_t kPolNone = 0 ：</strong>无特殊含义。</li>
<li><strong>const uint32_t kPolNegateEval = 1：</strong>将<code>EVAL_TRUE</code>转换为<code>EVAL_FALSE</code>，反之亦然。这允许表示否定条件，例如<code>if(a&amp;&amp;!b)</code></li>
<li><strong>const uint32_t kPolClearContext = 2：</strong>将<code>MatchContext</code>结构归零。这发生在操作码被<code>evaluated</code>之后。</li>
<li><strong>const uint32_t kPolUseOREval = 4：</strong>在评估这组操作码时使用 OR。默认情况下，策略评估器在评估时使用 AND。与 kPolNegateEval 一起使用时非常有用。例如使用这个标志可以把 if(! (a &amp;&amp; b &amp;&amp; c)) 表示为if ((!a) || (!b) || (!c))</li>
</ul>
<h3 id="Comparison-opcode"><a href="#Comparison-opcode" class="headerlink" title="Comparison opcode"></a>Comparison opcode</h3><ul>
<li><p><strong>EVAL_TRUE：</strong>  Opcode condition evaluated true.</p>
</li>
<li><p><strong>EVAL_FALSE：</strong> Opcode condition evaluated false.</p>
</li>
<li><p><strong>EVAL_ERROR：</strong>Opcode condition generated an error while evaluating.</p>
</li>
</ul>
<h3 id="Action-opcode"><a href="#Action-opcode" class="headerlink" title="Action opcode"></a>Action opcode</h3><ul>
<li><strong>ASK_BROKER：</strong>target 必须向 broker 生成一个IPC。在浏览器端，这意味着授予访问权限。</li>
<li><strong>DENY_ACCESS：</strong>没有授予对资源的访问权限。</li>
<li><strong>GIVE_READONLY：</strong>授予对资源的只读访问权限</li>
<li><strong>GIVE_ALLACCESS：</strong>授予对资源的完全访问权限。</li>
<li><strong>GIVE_CACHED：</strong>不需要 IPC。 target可以返回缓存的句柄。</li>
<li><strong>GIVE_FIRST：</strong>TODO(cpu)</li>
<li><strong>SIGNAL_ALARM：</strong> 不寻常的活动。 产生警报。</li>
<li><strong>FAKE_SUCCESS：</strong>不调用原始函数。 只需返回’成功’。</li>
<li><strong>FAKE_ACCESS_DENIED：</strong>不调用原始函数。 只需返回“拒绝”，不进行 IPC通信。</li>
<li><strong>TERMINATE_PROCESS：</strong>销毁target进程。 IPC通信。</li>
</ul>
<h2 id="Policyopcde"><a href="#Policyopcde" class="headerlink" title="Policyopcde"></a>Policyopcde</h2><p>policy opcode是基于此运营的，除了第一个参数都存储在此对象中进行裁决。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chromium/sandbox/win/src/policy_engine_opcodes.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PolicyOpcode</span> &#123;</span></span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">OpcodeFactory</span>;</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// 评估函数，根据opcode是comparison还是action，返回两类结果</span></span><br><span class="line">  <span class="comment">// parameters: 一个存储输入参数的数组</span></span><br><span class="line">  <span class="comment">// count: 第一个参数传递的参数的数量。</span></span><br><span class="line">  <span class="comment">// match: 在操作码求值序列中保留的匹配上下文。</span></span><br><span class="line">  <span class="function">EvalResult <span class="title">Evaluate</span><span class="params">(<span class="keyword">const</span> ParameterSet* parameters,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">size_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">                      MatchContext* match)</span></span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Valid index values are from 0 to &lt; kArgumentCount.</span></span><br><span class="line">  <span class="comment">// 根据 index，返回参数</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">GetArgument</span><span class="params">(<span class="keyword">size_t</span> index, T* argument)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static_assert</span>(<span class="keyword">sizeof</span>(T) &lt;= <span class="keyword">sizeof</span>(arguments_[<span class="number">0</span>]), <span class="string">&quot;invalid size&quot;</span>);</span><br><span class="line">    *argument = *<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> T*&gt;(&amp;arguments_[index].mem);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sets a stored argument by index. </span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">SetArgument</span><span class="params">(<span class="keyword">size_t</span> index, <span class="keyword">const</span> T&amp; argument)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static_assert</span>(<span class="keyword">sizeof</span>(T) &lt;= <span class="keyword">sizeof</span>(arguments_[<span class="number">0</span>]), <span class="string">&quot;invalid size&quot;</span>);</span><br><span class="line">    *<span class="keyword">reinterpret_cast</span>&lt;T*&gt;(&amp;arguments_[index].mem) = argument;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检索字符串参数的实际地址 </span></span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="keyword">wchar_t</span>* <span class="title">GetRelativeString</span><span class="params">(<span class="keyword">size_t</span> index)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ptrdiff_t</span> str_delta = <span class="number">0</span>;</span><br><span class="line">    GetArgument(index, &amp;str_delta);</span><br><span class="line">    <span class="comment">// 字符串的GetArgument返回的是一个offset</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* delta = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(<span class="keyword">this</span>) + str_delta;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">wchar_t</span>*&gt;(delta);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns true if this opcode is an action opcode without actually</span></span><br><span class="line">  <span class="comment">// evaluating it. Used to do a quick scan forward to the next opcode group.</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">IsAction</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> (OP_ACTION == opcode_id_); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns the opcode type.</span></span><br><span class="line">  <span class="function">OpcodeID <span class="title">GetID</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> opcode_id_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns the stored options such as kPolNegateEval and others.</span></span><br><span class="line">  <span class="function"><span class="keyword">uint32_t</span> <span class="title">GetOptions</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> options_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sets the stored options such as kPolNegateEval.</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">SetOptions</span><span class="params">(<span class="keyword">uint32_t</span> options)</span> </span>&#123; options_ = options; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Returns the parameter of the function the opcode concerns.</span></span><br><span class="line">  <span class="function"><span class="keyword">uint16_t</span> <span class="title">GetParameter</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> parameter_; &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">size_t</span> kArgumentCount = <span class="number">4</span>;  <span class="comment">// The number of supported argument.</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">OpcodeArgument</span> &#123;</span></span><br><span class="line">    UINT_PTR mem;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// Better define placement new in the class instead of relying on the</span></span><br><span class="line">  <span class="comment">// global definition which seems to be fubared.</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span>, <span class="keyword">void</span>* location)</span> </span>&#123; <span class="keyword">return</span> location; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 真正去评估的函数</span></span><br><span class="line">  <span class="function">EvalResult <span class="title">EvaluateHelper</span><span class="params">(<span class="keyword">const</span> ParameterSet* parameters,</span></span></span><br><span class="line"><span class="function"><span class="params">                            MatchContext* match)</span></span>;</span><br><span class="line">  OpcodeID opcode_id_;</span><br><span class="line">  <span class="keyword">int16_t</span> parameter_;</span><br><span class="line">  <span class="keyword">uint32_t</span> options_;</span><br><span class="line">  OpcodeArgument arguments_[PolicyOpcode::kArgumentCount];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="PolicyOpcode-Evaluate"><a href="#PolicyOpcode-Evaluate" class="headerlink" title="PolicyOpcode::Evaluate()"></a>PolicyOpcode::Evaluate()</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chromium/sandbox/win/src/policy_engine_opcodes.cc</span></span><br><span class="line"><span class="comment">//此函数是评估任何操作码的唯一入口。</span></span><br><span class="line"><span class="function">EvalResult <span class="title">PolicyOpcode::Evaluate</span><span class="params">(<span class="keyword">const</span> ParameterSet* call_params,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">size_t</span> param_count,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  MatchContext* match)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!call_params)</span><br><span class="line">    <span class="keyword">return</span> EVAL_ERROR;</span><br><span class="line">  <span class="keyword">const</span> ParameterSet* selected_param = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">if</span> (parameter_ &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">static_cast</span>&lt;<span class="keyword">size_t</span>&gt;(parameter_) &gt;= param_count) &#123;</span><br><span class="line">      <span class="keyword">return</span> EVAL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    selected_param = &amp;call_params[parameter_];</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="comment">//selected_param借助parameter_的值找到本次想要处理的ParameterSet</span></span><br><span class="line">  EvalResult result = EvaluateHelper(selected_param, match);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不管操作码的具体类型是什么，都应用通用选项。</span></span><br><span class="line">  <span class="keyword">if</span> (kPolNone == options_) &#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果本PolicyOpcode的标记了kPolNegateEval位，那么就要对结果取反（ERROR不管）</span></span><br><span class="line">  <span class="keyword">if</span> (options_ &amp; kPolNegateEval) &#123;</span><br><span class="line">    <span class="keyword">if</span> (EVAL_TRUE == result) &#123;</span><br><span class="line">      result = EVAL_FALSE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (EVAL_FALSE == result) &#123;</span><br><span class="line">      result = EVAL_TRUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (EVAL_ERROR != result) &#123;</span><br><span class="line">      result = EVAL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (match) &#123;</span><br><span class="line">      <span class="comment">// 如果标记了kPolClearContext位，那么要对辅助结构MatchContext进行清理工作</span></span><br><span class="line">    <span class="keyword">if</span> (options_ &amp; kPolClearContext)</span><br><span class="line">      match-&gt;Clear();</span><br><span class="line">      <span class="comment">// 如果标记了kPolUseOREval，那么就对辅助结构MatchContext打上标记</span></span><br><span class="line">    <span class="keyword">if</span> (options_ &amp; kPolUseOREval)</span><br><span class="line">      match-&gt;options = kPolUseOREval;<span class="comment">//默认是用AND来裁决，该标记表示用OR</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OPCODE_EVAL(op, x, y, z) \</span></span><br><span class="line">  <span class="keyword">case</span> op:                       \</span><br><span class="line">    <span class="keyword">return</span> OpcodeEval&lt;op&gt;(x, y, z)</span><br><span class="line"></span><br><span class="line">EvalResult PolicyOpcode::EvaluateHelper(<span class="keyword">const</span> ParameterSet* parameters,</span><br><span class="line">                                        MatchContext* match) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (opcode_id_) &#123;</span><br><span class="line">    OPCODE_EVAL(OP_ALWAYS_FALSE, <span class="keyword">this</span>, parameters, match);</span><br><span class="line">    OPCODE_EVAL(OP_ALWAYS_TRUE, <span class="keyword">this</span>, parameters, match);</span><br><span class="line">    OPCODE_EVAL(OP_NUMBER_MATCH, <span class="keyword">this</span>, parameters, match);</span><br><span class="line">    OPCODE_EVAL(OP_NUMBER_MATCH_RANGE, <span class="keyword">this</span>, parameters, match);</span><br><span class="line">    OPCODE_EVAL(OP_NUMBER_AND_MATCH, <span class="keyword">this</span>, parameters, match);</span><br><span class="line">    OPCODE_EVAL(OP_WSTRING_MATCH, <span class="keyword">this</span>, parameters, match);</span><br><span class="line">    OPCODE_EVAL(OP_ACTION, <span class="keyword">this</span>, parameters, match);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> EVAL_ERROR;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>EvaluateHelper</code> 根据<code>opcode_id_</code>来分类调用<code>OPCODE_EVAL</code>来评估</p>
<h3 id="OPCODE-EVAL"><a href="#OPCODE-EVAL" class="headerlink" title="OPCODE_EVAL()"></a>OPCODE_EVAL()</h3><p>每个<code>opcodeid</code> 都有其对应的<code>OpcodeEval</code>实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chromium/sandbox/win/src/policy_engine_opcodes.cc</span></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line">EvalResult OpcodeEval&lt;OP_ALWAYS_FALSE&gt;(PolicyOpcode* opcode,</span><br><span class="line">                                       <span class="keyword">const</span> ParameterSet* param,</span><br><span class="line">                                       MatchContext* context) &#123;</span><br><span class="line">  <span class="keyword">return</span> EVAL_FALSE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line">EvalResult OpcodeEval&lt;OP_ALWAYS_TRUE&gt;(PolicyOpcode* opcode,</span><br><span class="line">                                      <span class="keyword">const</span> ParameterSet* param,</span><br><span class="line">                                      MatchContext* context) &#123;</span><br><span class="line">  <span class="keyword">return</span> EVAL_TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line">EvalResult OpcodeEval&lt;OP_ACTION&gt;(PolicyOpcode* opcode,</span><br><span class="line">                                 <span class="keyword">const</span> ParameterSet* param,</span><br><span class="line">                                 MatchContext* context) &#123;</span><br><span class="line">  <span class="keyword">int</span> action = <span class="number">0</span>;</span><br><span class="line">  opcode-&gt;GetArgument(<span class="number">0</span>, &amp;action);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;EvalResult&gt;(action);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line">EvalResult OpcodeEval&lt;OP_NUMBER_AND_MATCH&gt;(PolicyOpcode* opcode,</span><br><span class="line">                                           <span class="keyword">const</span> ParameterSet* param,</span><br><span class="line">                                           MatchContext* context) &#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> value = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (!param-&gt;Get(&amp;value))</span><br><span class="line">    <span class="keyword">return</span> EVAL_ERROR;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint32_t</span> number = <span class="number">0</span>;</span><br><span class="line">  opcode-&gt;GetArgument(<span class="number">0</span>, &amp;number);</span><br><span class="line">  <span class="keyword">return</span> (number &amp; value) ? EVAL_TRUE : EVAL_FALSE;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>如果是 match 类的 ID，其最终就是 opcode内存储的<code>Argument</code>和<code>param</code>的比较，返回 TRUE or FALSE</p>
<p>如果是 OP_ACTION，则返回其对应的<code>EvalResult</code>，如：askbroker.</p>
<h2 id="OpcodeFactory"><a href="#OpcodeFactory" class="headerlink" title="OpcodeFactory"></a>OpcodeFactory</h2><p>opcode 的一个工程类，用来make opcode</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chromium/sandbox/win/src/policy_engine_opcodes.h</span></span><br><span class="line"><span class="comment">// Factory通过使用构造函数中给定的内存块创建操作码来工作。 </span></span><br><span class="line"><span class="comment">//操作码本身是从内存的开头（顶部）分配的，而操作码需要的任何字符串都是从内存的结尾（底部）分配的。</span></span><br><span class="line"><span class="comment">// In essence:</span></span><br><span class="line"><span class="comment">//   low address ---&gt; [opcode 1]</span></span><br><span class="line"><span class="comment">//                    [opcode 2]</span></span><br><span class="line"><span class="comment">//                    [opcode 3]</span></span><br><span class="line"><span class="comment">//                    |        | &lt;--- memory_top_</span></span><br><span class="line"><span class="comment">//                    | free   |</span></span><br><span class="line"><span class="comment">//                    |        |</span></span><br><span class="line"><span class="comment">//                    |        | &lt;--- memory_bottom_</span></span><br><span class="line"><span class="comment">//                    [string 1]</span></span><br><span class="line"><span class="comment">//   high address --&gt; [string 2]</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpcodeFactory</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// memory: 指向创建操作码的内存块的基指针。</span></span><br><span class="line">    <span class="comment">// memory_size: chunk size</span></span><br><span class="line">  OpcodeFactory(<span class="keyword">char</span>* memory, <span class="keyword">size_t</span> memory_size) : memory_top_(memory) &#123;</span><br><span class="line">    memory_bottom_ = &amp;memory_top_[memory_size];</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="comment">// policy:包含创建操作码的原始内存</span></span><br><span class="line">  OpcodeFactory(PolicyBuffer* policy, <span class="keyword">size_t</span> memory_size) &#123;</span><br><span class="line">    memory_top_ = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(&amp;policy-&gt;opcodes[<span class="number">0</span>]);</span><br><span class="line">    memory_bottom_ = &amp;memory_top_[memory_size];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">size_t</span> <span class="title">memory_size</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    DCHECK_GE(memory_bottom_, memory_top_);</span><br><span class="line">    <span class="keyword">return</span> memory_bottom_ - memory_top_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Creates an OpAlwaysFalse opcode.</span></span><br><span class="line">  <span class="function">PolicyOpcode* <span class="title">MakeOpAlwaysFalse</span><span class="params">(<span class="keyword">uint32_t</span> options)</span></span>;</span><br><span class="line">  <span class="function">PolicyOpcode* <span class="title">MakeOpAlwaysTrue</span><span class="params">(<span class="keyword">uint32_t</span> options)</span></span>;</span><br><span class="line">  <span class="function">PolicyOpcode* <span class="title">MakeOpAction</span><span class="params">(EvalResult action, <span class="keyword">uint32_t</span> options)</span></span>;</span><br><span class="line">  <span class="function">PolicyOpcode* <span class="title">MakeOpNumberMatch</span><span class="params">(<span class="keyword">int16_t</span> selected_param,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">uint32_t</span> match,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">uint32_t</span> options)</span></span>;</span><br><span class="line">  <span class="function">PolicyOpcode* <span class="title">MakeOpVoidPtrMatch</span><span class="params">(<span class="keyword">int16_t</span> selected_param,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">const</span> <span class="keyword">void</span>* match,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">uint32_t</span> options)</span></span>;</span><br><span class="line">  <span class="function">PolicyOpcode* <span class="title">MakeOpNumberMatchRange</span><span class="params">(<span class="keyword">int16_t</span> selected_param,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">uint32_t</span> lower_bound,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">uint32_t</span> upper_bound,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">uint32_t</span> options)</span></span>;</span><br><span class="line">  <span class="function">PolicyOpcode* <span class="title">MakeOpWStringMatch</span><span class="params">(<span class="keyword">int16_t</span> selected_param,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">const</span> <span class="keyword">wchar_t</span>* match_str,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">int</span> start_position,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   StringMatchOptions match_opts,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">uint32_t</span> options)</span></span>;</span><br><span class="line">  <span class="function">PolicyOpcode* <span class="title">MakeOpNumberAndMatch</span><span class="params">(<span class="keyword">int16_t</span> selected_param,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">uint32_t</span> match,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">uint32_t</span> options)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="function">PolicyOpcode* <span class="title">MakeBase</span><span class="params">(OpcodeID opcode_id,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">uint32_t</span> options,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">int16_t</span> selected_param)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">ptrdiff_t</span> <span class="title">AllocRelative</span><span class="params">(<span class="keyword">void</span>* start, <span class="keyword">const</span> <span class="keyword">wchar_t</span>* str, <span class="keyword">size_t</span> length)</span></span>;</span><br><span class="line">  <span class="keyword">char</span>* memory_top_;</span><br><span class="line">  <span class="keyword">char</span>* memory_bottom_;</span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(OpcodeFactory);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中比较重要的是<code>MakeBase()</code>，所有的 make，最后都会调用这个函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PolicyOpcode* <span class="title">OpcodeFactory::MakeBase</span><span class="params">(OpcodeID opcode_id,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="keyword">uint32_t</span> options,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="keyword">int16_t</span> selected_param)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (memory_size() &lt; <span class="keyword">sizeof</span>(PolicyOpcode))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// opcode从top开始向下占用buffer</span></span><br><span class="line">  PolicyOpcode* opcode = <span class="keyword">new</span> (memory_top_) PolicyOpcode();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fill in the standard fields, that every opcode has.</span></span><br><span class="line">  memory_top_ += <span class="keyword">sizeof</span>(PolicyOpcode);</span><br><span class="line">  opcode-&gt;opcode_id_ = opcode_id;	<span class="comment">// 标记 opcode type</span></span><br><span class="line">  opcode-&gt;SetOptions(options);		<span class="comment">// 标记 opcode options</span></span><br><span class="line">  <span class="comment">// 传入的selected_param表示用于和该PolicyOpcode比较的参数在ParameterSet中是第几个，也就是索引</span></span><br><span class="line">  opcode-&gt;parameter_ = selected_param;	</span><br><span class="line">  <span class="keyword">return</span> opcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Filesystem"><a href="#Filesystem" class="headerlink" title="Filesystem"></a>Filesystem</h1><p>Target在执行5个文件系统相关的API时，会因为Interceptions的部署（该子系统由broker远程部署(service call)）而调用hook函数，hook函数通过SharedMem IPC与broker通信，将调用参数传给broker，broker此后通过dispatcher分发找到对应子系统的dispatcher，子系统dispatcher会匹配调用参数并调用一早便注册好的callback，callback会进行Low-level policy的Evaluate鉴权，并进一步调用low-level policy的业务处理函数，根据鉴权结果来执行API，并在CrossCallResult回执结果。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chromium/sandbox/win/src/filesystem_policy.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileSystemPolicy</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// 创建所需的低级策略规则来评估文件 IO 的高级策略规则，尤其是文件打开或创建操作。</span></span><br><span class="line">  <span class="comment">// &#x27;name&#x27; 是文件名或目录名。 “语义”。 </span></span><br><span class="line">  <span class="comment">// &#x27;semantics&#x27; 是打开或创建所需的语义</span></span><br><span class="line">  <span class="comment">//&#x27;policy&#x27; 是将要添加规则的策略生成器。</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">GenerateRules</span><span class="params">(<span class="keyword">const</span> <span class="keyword">wchar_t</span>* name,</span></span></span><br><span class="line"><span class="function"><span class="params">                            TargetPolicy::Semantics semantics,</span></span></span><br><span class="line"><span class="function"><span class="params">                            LowLevelPolicy* policy)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add basic file system rules.</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">SetInitialRules</span><span class="params">(LowLevelPolicy* policy)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IPC 收到 creat file 请求时的操作</span></span><br><span class="line">  <span class="comment">// &#x27;client_info&#x27; :发出请求的目标进程。</span></span><br><span class="line">  <span class="comment">// &#x27;eval_result&#x27; : 要完成的预期策略操作。</span></span><br><span class="line">  <span class="comment">// &#x27;file&#x27; : 目标文件或目录。</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CreateFileAction</span><span class="params">(EvalResult eval_result,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">const</span> ClientInfo&amp; client_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">wstring</span>&amp; file,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">uint32_t</span> attributes,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">uint32_t</span> desired_access,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">uint32_t</span> file_attributes,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">uint32_t</span> share_access,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">uint32_t</span> create_disposition,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">uint32_t</span> create_options,</span></span></span><br><span class="line"><span class="function"><span class="params">                               HANDLE* handle,</span></span></span><br><span class="line"><span class="function"><span class="params">                               NTSTATUS* nt_status,</span></span></span><br><span class="line"><span class="function"><span class="params">                               ULONG_PTR* io_information)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IPC 收到 open file 请求时的操作</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">OpenFileAction</span><span class="params">(EvalResult eval_result,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">const</span> ClientInfo&amp; client_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">wstring</span>&amp; file,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">uint32_t</span> attributes,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">uint32_t</span> desired_access,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">uint32_t</span> share_access,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">uint32_t</span> open_options,</span></span></span><br><span class="line"><span class="function"><span class="params">                             HANDLE* handle,</span></span></span><br><span class="line"><span class="function"><span class="params">                             NTSTATUS* nt_status,</span></span></span><br><span class="line"><span class="function"><span class="params">                             ULONG_PTR* io_information)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IPC 收到 Query 请求时的操作</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">QueryAttributesFileAction</span><span class="params">(EvalResult eval_result,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">const</span> ClientInfo&amp; client_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">wstring</span>&amp; file,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">uint32_t</span> attributes,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        FILE_BASIC_INFORMATION* file_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        NTSTATUS* nt_status)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IPC 收到 Query full请求时的操作</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">QueryFullAttributesFileAction</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      EvalResult eval_result,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> ClientInfo&amp; client_info,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">wstring</span>&amp; file,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">uint32_t</span> attributes,</span></span></span><br><span class="line"><span class="function"><span class="params">      FILE_NETWORK_OPEN_INFORMATION* file_info,</span></span></span><br><span class="line"><span class="function"><span class="params">      NTSTATUS* nt_status)</span></span>;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// // IPC收到的set_info 请求时的操作</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">SetInformationFileAction</span><span class="params">(EvalResult eval_result,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">const</span> ClientInfo&amp; client_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       HANDLE target_file_handle,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">void</span>* file_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">uint32_t</span> length,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">uint32_t</span> info_class,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       IO_STATUS_BLOCK* io_block,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       NTSTATUS* nt_status)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>chrome的Windows版Sandbox是利用系统的</p>
<ul>
<li><p>user32!CreateDesktopW</p>
</li>
<li><p>kernel32!CreateJobObjectW</p>
</li>
<li><p>advapi32!CreateRestrictedToken</p>
</li>
<li><p>advapi32!CreateProcessAsUserW</p>
</li>
<li><p>advapi32!SetThreadToken</p>
</li>
<li><p>advapi32!RevertToSelf</p>
</li>
</ul>
<p>这些API为每个网页单独建立一个权限受限的renderer子进程专门用来解析网页, 如果网页有什么越轨的行为就销毁这个renderer子进程. 因为renderer子进程权限太低无法进行诸如下载上传文件这些操作, chrome改写了renderer子进程10个API, 如果参数合乎policy要求就让正常权限的browser主进程代为完成。</p>
<ul>
<li><p>ntdll!NtCreateFile</p>
</li>
<li><p>ntdll!NtOpenFile</p>
</li>
<li><p>ntdll!NtQueryAttributesFile</p>
</li>
<li><p>ntdll!NtQueryFullAttributesFile</p>
</li>
<li><p>ntdll!NtSetInformationFile</p>
</li>
<li><p>ntdll!NtOpenThread</p>
</li>
<li><p>ntdll!NtOpenProcess</p>
</li>
<li><p>ntdll!NtOpenProcessToken</p>
</li>
<li><p>ntdll!NtSetInformationThread</p>
</li>
<li><p>ntdll!NtOpenThreadToken</p>
</li>
</ul>
<h2 id="FileSystemPolicy-GenerateRules"><a href="#FileSystemPolicy-GenerateRules" class="headerlink" title="FileSystemPolicy::GenerateRules"></a>FileSystemPolicy::GenerateRules</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chromium/sandbox/win/src/filesystem_policy.cc</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FileSystemPolicy::GenerateRules</span><span class="params">(<span class="keyword">const</span> <span class="keyword">wchar_t</span>* name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     TargetPolicy::Semantics semantics,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     LowLevelPolicy* policy)</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::<span class="built_in">wstring</span> <span class="title">mod_name</span><span class="params">(name)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (mod_name.empty()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//处理 mod_name。</span></span><br><span class="line">  <span class="keyword">if</span> (!PreProcessName(&amp;mod_name)) &#123;</span><br><span class="line">    <span class="comment">// The path to be added might contain a reparse point.</span></span><br><span class="line">    NOTREACHED();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(cpu) bug 32224: This prefix add is a hack because we don&#x27;t have the</span></span><br><span class="line">  <span class="comment">// infrastructure to normalize names. In any case we need to escape the</span></span><br><span class="line">  <span class="comment">// question marks.</span></span><br><span class="line">  <span class="keyword">if</span> (_wcsnicmp(mod_name.c_str(), kNTDevicePrefix, kNTDevicePrefixLen)) &#123;</span><br><span class="line">    mod_name = FixNTPrefixForMatch(mod_name);</span><br><span class="line">    name = mod_name.c_str();</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 设定 ASK_broker</span></span><br><span class="line">  EvalResult result = ASK_BROKER;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// List of supported calls for the filesystem.</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> kCallNtCreateFile = <span class="number">0x1</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> kCallNtOpenFile = <span class="number">0x2</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> kCallNtQueryAttributesFile = <span class="number">0x4</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> kCallNtQueryFullAttributesFile = <span class="number">0x8</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> kCallNtSetInfoRename = <span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line">  DWORD rule_to_add = kCallNtOpenFile | kCallNtCreateFile |</span><br><span class="line">                      kCallNtQueryAttributesFile |</span><br><span class="line">                      kCallNtQueryFullAttributesFile | kCallNtSetInfoRename;</span><br><span class="line">  <span class="comment">//创建 5 个PolicyRule，分别管制5种请求，action为ASK_BROKER</span></span><br><span class="line">  <span class="function">PolicyRule <span class="title">create</span><span class="params">(result)</span></span>;</span><br><span class="line">  <span class="function">PolicyRule <span class="title">open</span><span class="params">(result)</span></span>;</span><br><span class="line">  <span class="function">PolicyRule <span class="title">query</span><span class="params">(result)</span></span>;</span><br><span class="line">  <span class="function">PolicyRule <span class="title">query_full</span><span class="params">(result)</span></span>;</span><br><span class="line">  <span class="function">PolicyRule <span class="title">rename</span><span class="params">(result)</span></span>;</span><br><span class="line">  <span class="comment">//根据不同的semantics，添加不同的 policy</span></span><br><span class="line">  <span class="keyword">switch</span> (semantics) &#123;</span><br><span class="line">    <span class="keyword">case</span> TargetPolicy::FILES_ALLOW_DIR_ANY: &#123;</span><br><span class="line">      open.AddNumberMatch(IF, OpenFile::OPTIONS, FILE_DIRECTORY_FILE, AND);</span><br><span class="line">      create.AddNumberMatch(IF, OpenFile::OPTIONS, FILE_DIRECTORY_FILE, AND);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> TargetPolicy::FILES_ALLOW_READONLY: &#123;</span><br><span class="line">      <span class="comment">// We consider all flags that are not known to be readonly as potentially</span></span><br><span class="line">      <span class="comment">// used for write.</span></span><br><span class="line">      DWORD allowed_flags = FILE_READ_DATA | FILE_READ_ATTRIBUTES |</span><br><span class="line">                            FILE_READ_EA | SYNCHRONIZE | FILE_EXECUTE |</span><br><span class="line">                            GENERIC_READ | GENERIC_EXECUTE | READ_CONTROL;</span><br><span class="line">      DWORD restricted_flags = ~allowed_flags;</span><br><span class="line">      open.AddNumberMatch(IF_NOT, OpenFile::ACCESS, restricted_flags, AND);</span><br><span class="line">      open.AddNumberMatch(IF, OpenFile::DISPOSITION, FILE_OPEN, EQUAL);</span><br><span class="line">      create.AddNumberMatch(IF_NOT, OpenFile::ACCESS, restricted_flags, AND);</span><br><span class="line">      create.AddNumberMatch(IF, OpenFile::DISPOSITION, FILE_OPEN, EQUAL);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Read only access don&#x27;t work for rename.</span></span><br><span class="line">      rule_to_add &amp;= ~kCallNtSetInfoRename;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> TargetPolicy::FILES_ALLOW_QUERY: &#123;</span><br><span class="line">      <span class="comment">// Here we don&#x27;t want to add policy for the open or the create.</span></span><br><span class="line">      rule_to_add &amp;=</span><br><span class="line">          ~(kCallNtOpenFile | kCallNtCreateFile | kCallNtSetInfoRename);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> TargetPolicy::FILES_ALLOW_ANY: &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      NOTREACHED();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 根据当前rule_to_add的状态，把OpenFile::NAME这一参数进行设置</span></span><br><span class="line">  <span class="comment">// PolicyRule add好以后，就通过policy-&gt;AddRule添加到LowLevelPolicy中</span></span><br><span class="line">  <span class="comment">// 注意AddRule时会绑定service id和PolicyRule</span></span><br><span class="line">  <span class="comment">// filesystem子系统占用了5个service id，分别对应open, create, rename, query, queryFull</span></span><br><span class="line">  <span class="keyword">if</span> ((rule_to_add &amp; kCallNtCreateFile) &amp;&amp;</span><br><span class="line">      (!create.AddStringMatch(IF, OpenFile::NAME, name, CASE_INSENSITIVE) ||</span><br><span class="line">       !policy-&gt;AddRule(IpcTag::NTCREATEFILE, &amp;create))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((rule_to_add &amp; kCallNtOpenFile) &amp;&amp;</span><br><span class="line">      (!open.AddStringMatch(IF, OpenFile::NAME, name, CASE_INSENSITIVE) ||</span><br><span class="line">       !policy-&gt;AddRule(IpcTag::NTOPENFILE, &amp;open))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((rule_to_add &amp; kCallNtQueryAttributesFile) &amp;&amp;</span><br><span class="line">      (!query.AddStringMatch(IF, FileName::NAME, name, CASE_INSENSITIVE) ||</span><br><span class="line">       !policy-&gt;AddRule(IpcTag::NTQUERYATTRIBUTESFILE, &amp;query))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((rule_to_add &amp; kCallNtQueryFullAttributesFile) &amp;&amp;</span><br><span class="line">      (!query_full.AddStringMatch(IF, FileName::NAME, name, CASE_INSENSITIVE) ||</span><br><span class="line">       !policy-&gt;AddRule(IpcTag::NTQUERYFULLATTRIBUTESFILE, &amp;query_full))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((rule_to_add &amp; kCallNtSetInfoRename) &amp;&amp;</span><br><span class="line">      (!rename.AddStringMatch(IF, FileName::NAME, name, CASE_INSENSITIVE) ||</span><br><span class="line">       !policy-&gt;AddRule(IpcTag::NTSETINFO_RENAME, &amp;rename))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是调用的实例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chromium/sandbox/win/src/sandbox_policy_base.cc</span></span><br><span class="line"><span class="function">ResultCode <span class="title">PolicyBase::AddRuleInternal</span><span class="params">(SubSystem subsystem,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Semantics semantics,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">const</span> <span class="keyword">wchar_t</span>* pattern)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!policy_) &#123;</span><br><span class="line">     <span class="comment">// 如果policy_未被设置，make一个4096*14尺寸的PolicyGlobal</span></span><br><span class="line">    policy_ = MakeBrokerPolicyMemory();</span><br><span class="line">    DCHECK(policy_);</span><br><span class="line">     <span class="comment">// 使用该PolicyGlobal new出一个LowLevelPolicy</span></span><br><span class="line">    policy_maker_ = <span class="keyword">new</span> LowLevelPolicy(policy_);</span><br><span class="line">    DCHECK(policy_maker_);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (subsystem) &#123;</span><br><span class="line">    <span class="keyword">case</span> SUBSYS_FILES: &#123;</span><br><span class="line">      <span class="keyword">if</span> (!file_system_init_) &#123; <span class="comment">//确定 filesystem 被初始化，一开始file_system_init_是false</span></span><br><span class="line">        <span class="keyword">if</span> (!FileSystemPolicy::SetInitialRules(policy_maker_))</span><br><span class="line">            <span class="comment">// 执行完SetInitialRules后，file_system_init_置true，即SetInitialRules只执行一次</span></span><br><span class="line">          <span class="keyword">return</span> SBOX_ERROR_BAD_PARAMS;</span><br><span class="line">        file_system_init_ = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">        <span class="comment">// 根据传入的pattern,semantics，用LowLevelPolicy生成一个rule</span></span><br><span class="line">      <span class="keyword">if</span> (!FileSystemPolicy::GenerateRules(pattern, semantics, policy_maker_)) &#123;</span><br><span class="line">        NOTREACHED();</span><br><span class="line">        <span class="keyword">return</span> SBOX_ERROR_BAD_PARAMS;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> SBOX_ALL_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FileSystemPolicy-SetInitialRules"><a href="#FileSystemPolicy-SetInitialRules" class="headerlink" title="FileSystemPolicy::SetInitialRules()"></a>FileSystemPolicy::SetInitialRules()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FileSystemPolicy::SetInitialRules</span><span class="params">(LowLevelPolicy* policy)</span> </span>&#123;</span><br><span class="line">  <span class="function">PolicyRule <span class="title">format</span><span class="params">(ASK_BROKER)</span></span>;</span><br><span class="line">  <span class="function">PolicyRule <span class="title">short_name</span><span class="params">(ASK_BROKER)</span></span>;</span><br><span class="line">  <span class="comment">// 两个ASK_BROKER的action rule</span></span><br><span class="line">    </span><br><span class="line">  <span class="keyword">bool</span> rv = format.AddNumberMatch(IF_NOT, FileName::BROKER, BROKER_TRUE, AND);</span><br><span class="line">  rv &amp;= format.AddStringMatch(IF_NOT, FileName::NAME, <span class="string">L&quot;\\/?/?\\*&quot;</span>,</span><br><span class="line">                              CASE_SENSITIVE);</span><br><span class="line">  <span class="comment">// format按位与匹配FileName::BROKER没有BROKER_TRUE标志位</span></span><br><span class="line">  rv &amp;= short_name.AddNumberMatch(IF_NOT, FileName::BROKER, BROKER_TRUE, AND);</span><br><span class="line">  <span class="comment">// 匹配FileName::NAME不能为L&quot;\\/?/?\\*&quot;</span></span><br><span class="line">  rv &amp;= short_name.AddStringMatch(IF, FileName::NAME, <span class="string">L&quot;*~*&quot;</span>, CASE_SENSITIVE);</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 为5个service id，各添加这两个rule到LowLevelPolicy</span></span><br><span class="line">  <span class="keyword">if</span> (!rv || !policy-&gt;AddRule(IpcTag::NTCREATEFILE, &amp;format))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!policy-&gt;AddRule(IpcTag::NTCREATEFILE, &amp;short_name))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!policy-&gt;AddRule(IpcTag::NTOPENFILE, &amp;format))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!policy-&gt;AddRule(IpcTag::NTOPENFILE, &amp;short_name))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!policy-&gt;AddRule(IpcTag::NTQUERYATTRIBUTESFILE, &amp;format))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!policy-&gt;AddRule(IpcTag::NTQUERYATTRIBUTESFILE, &amp;short_name))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!policy-&gt;AddRule(IpcTag::NTQUERYFULLATTRIBUTESFILE, &amp;format))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!policy-&gt;AddRule(IpcTag::NTQUERYFULLATTRIBUTESFILE, &amp;short_name))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!policy-&gt;AddRule(IpcTag::NTSETINFO_RENAME, &amp;format))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!policy-&gt;AddRule(IpcTag::NTSETINFO_RENAME, &amp;short_name))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个初始化函数为 low-level policy 定制一了一套初级的策略。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><strong>FileSystem的low-level policy部分做了两件事：</strong></p>
<ul>
<li>为<code>PolicyBase::AddRule</code>提供了该子系统5个service或者叫action的Rule制定接口。</li>
<li>编写了broker端5个(create, open, rename, query, queryFull)请求的处理，在broker端调用了对应的API函数。</li>
</ul>
<h1 id="edge-sandbox"><a href="#edge-sandbox" class="headerlink" title="edge://sandbox"></a>edge://sandbox</h1><p>当我们在 edge 输入 edge://sandbox 会返回如下界面</p>
<p><img src= "https://i.loli.net/2020/07/14/shCfncNLw9axrt8.gif" data-lazy-src="https://focu5.oss-accelerate.aliyuncs.com/blog/20210802183113.png" alt="image-20210728192811294"></p>
<p>粗略的看，里面包含一个活动进程表(不包括浏览器进程，因为它没有被沙箱化)和一些摘要信息，然后和每个进程的详细沙箱配置的原始数据转储成的 JSON 序列。关于像 <code>NtCreateFile</code>这些<code>service</code>的 policy 是如何设置的在上文已经进行过解读，下文主要分析一下这个页面是什么含义。</p>
<p>以以下序列为例，进行解读。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;desiredIntegrityLevel&quot;</span>: <span class="string">&quot;S-1-16-4096 Low&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;desiredMitigations&quot;</span>: <span class="string">&quot;0000000000af1267&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;disconnectCsrss&quot;</span>: <span class="string">&quot;disabled&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jobLevel&quot;</span>: <span class="string">&quot;Limited User&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;lockdownLevel&quot;</span>: <span class="string">&quot;Limited&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;platformMitigations&quot;</span>: <span class="string">&quot;01111001000110000000000000010000&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;policyRules&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;CreateNamedPipeW&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\\\.\\pipe\\LOCAL\\chrome.sync.&#x27;) -&gt; askBroker&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;NtCreateFile&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; !(prefix(p[0], &#x27;\\??\\&#x27;)) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; scan(p[0], &#x27;~&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\chrome.&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\LOCAL\\chrome.&#x27;) -&gt; askBroker&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;NtOpenFile&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; !(prefix(p[0], &#x27;\\??\\&#x27;)) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; scan(p[0], &#x27;~&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\chrome.&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\LOCAL\\chrome.&#x27;) -&gt; askBroker&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;NtQueryAttributesFile&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; !(prefix(p[0], &#x27;\\??\\&#x27;)) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; scan(p[0], &#x27;~&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\chrome.&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\LOCAL\\chrome.&#x27;) -&gt; askBroker&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;NtQueryFullAttributesFile&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; !(prefix(p[0], &#x27;\\??\\&#x27;)) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; scan(p[0], &#x27;~&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\chrome.&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\LOCAL\\chrome.&#x27;) -&gt; askBroker&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;NtSetInfoRename&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; !(prefix(p[0], &#x27;\\??\\&#x27;)) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;!(p[1] &amp; 1) &amp;&amp; scan(p[0], &#x27;~&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\chrome.&#x27;) -&gt; askBroker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefix_i(p[0], &#x27;\\??\\pipe\\LOCAL\\chrome.&#x27;) -&gt; askBroker&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;processIds&quot;</span>: [</span><br><span class="line">      <span class="number">4888</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>关于<code>Mitigations</code>我们可以使用 google 提供的解码器进行解码：<a target="_blank" rel="noopener" href="https://docs.google.com/a/chromium.org/viewer?a=v&amp;pid=sites&amp;srcid=Y2hyb21pdW0ub3JnfGRldnxneDo3MDg0MDMzODNjODgzMDMy">https://docs.google.com/a/chromium.org/viewer?a=v&amp;pid=sites&amp;srcid=Y2hyb21pdW0ub3JnfGRldnxneDo3MDg0MDMzODNjODgzMDMy</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Paste mitigation values from chrome:&#x2F;&#x2F;sandbox output.</span><br><span class="line">Chrome (desiredMitigations): </span><br><span class="line">0000000000af1267</span><br><span class="line"></span><br><span class="line">Platform (platformMitigations): </span><br><span class="line">01111001000110000000000000010000</span><br><span class="line"></span><br><span class="line">MITIGATION_DEP</span><br><span class="line">MITIGATION_DEP_NO_ATL_THUNK</span><br><span class="line">MITIGATION_SEHOP</span><br><span class="line">MITIGATION_HEAP_TERMINATE</span><br><span class="line">MITIGATION_BOTTOM_UP_ASLR</span><br><span class="line">MITIGATION_DLL_SEARCH_ORDER</span><br><span class="line">MITIGATION_EXTENSION_POINT_DISABLE</span><br><span class="line">MITIGATION_NONSYSTEM_FONT_DISABLE</span><br><span class="line">MITIGATION_FORCE_MS_SIGNED_BINS</span><br><span class="line">MITIGATION_IMAGE_LOAD_NO_REMOTE</span><br><span class="line">MITIGATION_IMAGE_LOAD_NO_LOW_LABEL</span><br><span class="line">MITIGATION_RESTRICT_INDIRECT_BRANCH_PREDICTION</span><br><span class="line"></span><br><span class="line">HEAP_TERMINATE_ALWAYS_ON</span><br><span class="line">BOTTOM_UP_ASLR_ALWAYS_ON</span><br><span class="line">EXTENSION_POINT_DISABLE_ALWAYS_ON</span><br><span class="line">BLOCK_NON_MICROSOFT_BINARIES_ALWAYS_ON</span><br><span class="line">FONT_DISABLE_ALWAYS_ON</span><br><span class="line">IMAGE_LOAD_NO_REMOTE_ALWAYS_ON</span><br><span class="line">IMAGE_LOAD_NO_LOW_LABEL_ALWAYS_ON</span><br><span class="line">RESTRICT_INDIRECT_BRANCH_PREDICTION_ALWAYS_ON</span><br></pre></td></tr></table></figure>

<p>其中很大一部分都是在构造函数中传递的数值，这里主要分析一下<code>policyRules</code>，调用如下函数：</p>
<h2 id="GetPolicyRules"><a href="#GetPolicyRules" class="headerlink" title="GetPolicyRules"></a>GetPolicyRules</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">base::Value <span class="title">GetPolicyRules</span><span class="params">(<span class="keyword">const</span> PolicyGlobal* policy_rules)</span> </span>&#123;</span><br><span class="line">  DCHECK(policy_rules);</span><br><span class="line">  <span class="function">base::Value <span class="title">results</span><span class="params">(base::Value::Type::DICTIONARY)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kMaxServiceCount; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!policy_rules-&gt;entry[i])</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    IpcTag service = <span class="keyword">static_cast</span>&lt;IpcTag&gt;(i);</span><br><span class="line">    results.SetKey(GetIpcTagAsString(service), <span class="comment">//根据 service 去获取其policy_rules</span></span><br><span class="line">                   GetPolicyOpcodes(policy_rules, service));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>GetPolicyRules</code>内部又会调用<code>GetIpcTagAsString</code>来获取 Ipc 的 tag，如：<code>NtCreateFile</code>这些，然后紧接着对这些 tag 的 policy 进行解析，调用<code>GetPolicyOpcodes</code></p>
<p><code>entry</code>指针数组，用以索引<code>PolicyGlobal</code>内每个<code>PolicyBuffer</code>。<code>PolicyBuffer</code> 是一个结构体，它包含要按顺序创建或评估的所有操作码。</p>
<blockquote>
<p>struct PolicyBuffer {</p>
<p> size_t opcode_count;</p>
<p> PolicyOpcode opcodes[1];</p>
<p>};</p>
</blockquote>
<h2 id="GetPolicyOpcodes"><a href="#GetPolicyOpcodes" class="headerlink" title="GetPolicyOpcodes"></a>GetPolicyOpcodes</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">base::Value <span class="title">GetPolicyOpcodes</span><span class="params">(<span class="keyword">const</span> PolicyGlobal* policy_rules, IpcTag service)</span> </span>&#123;</span><br><span class="line">  <span class="function">base::Value <span class="title">entry</span><span class="params">(base::Value::Type::LIST)</span></span>;</span><br><span class="line">  PolicyBuffer* policy_buffer = policy_rules-&gt;entry[<span class="keyword">static_cast</span>&lt;<span class="keyword">size_t</span>&gt;(service)];</span><br><span class="line">  <span class="comment">// Build up rules and emit when we hit an action.</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> cur_rule;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; policy_buffer-&gt;opcode_count; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> PolicyOpcode* opcode = &amp;policy_buffer-&gt;opcodes[i];</span><br><span class="line">    <span class="keyword">if</span> (opcode-&gt;GetID() != OP_ACTION) &#123; <span class="comment">//获取 opcodeID，也就是 OPCODE 类型</span></span><br><span class="line">      DCHECK(i + <span class="number">1</span> &lt; policy_buffer-&gt;opcode_count)</span><br><span class="line">          &lt;&lt; <span class="string">&quot;Non-actions should not terminate rules&quot;</span>;</span><br><span class="line">        <span class="comment">//如果下个 OPCODE 类型不是OP_ACTION，则返回 true</span></span><br><span class="line">      <span class="keyword">bool</span> peak = policy_buffer-&gt;opcodes[i + <span class="number">1</span>].GetID() != OP_ACTION; </span><br><span class="line">        <span class="comment">//获取opcode</span></span><br><span class="line">      cur_rule += GetPolicyOpcode(opcode, peak);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cur_rule += <span class="string">&quot; -&gt; &quot;</span>;</span><br><span class="line">      cur_rule += GetPolicyOpcode(opcode, <span class="literal">false</span>);</span><br><span class="line">      entry.Append(cur_rule);</span><br><span class="line">      cur_rule.clear();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="GetPolicyOpcode"><a href="#GetPolicyOpcode" class="headerlink" title="GetPolicyOpcode"></a>GetPolicyOpcode</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">GetPolicyOpcode</span><span class="params">(<span class="keyword">const</span> PolicyOpcode* opcode, <span class="keyword">bool</span> continuation)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// See |policy_engine_opcodes.cc|.</span></span><br><span class="line">  <span class="keyword">uint32_t</span> args[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">auto</span> options = opcode-&gt;GetOptions(); <span class="comment">//获取Options，如kPolNegateEval</span></span><br><span class="line">  <span class="keyword">auto</span> param = opcode-&gt;GetParameter(); <span class="comment">//返回操作码所关系的函数的参数。 </span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> condition;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options &amp; kPolNegateEval) <span class="comment">//检测 opcode 是否标志kPolNegateEval</span></span><br><span class="line">    condition += <span class="string">&quot;!(&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (opcode-&gt;GetID()) &#123;</span><br><span class="line">    <span class="keyword">case</span> OP_ALWAYS_FALSE:</span><br><span class="line">      condition += <span class="string">&quot;false&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OP_ALWAYS_TRUE:</span><br><span class="line">      condition += <span class="string">&quot;true&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OP_NUMBER_MATCH:</span><br><span class="line">      opcode-&gt;GetArgument(<span class="number">1</span>, &amp;args[<span class="number">1</span>]); <span class="comment">//返回存储的参数</span></span><br><span class="line">      <span class="keyword">if</span> (args[<span class="number">1</span>] == UINT32_TYPE) &#123; <span class="comment">//UINT32_TYPE:支持的 C++ 类型编码为数字 id</span></span><br><span class="line">        opcode-&gt;GetArgument(<span class="number">0</span>, &amp;args[<span class="number">0</span>]);</span><br><span class="line">        condition += base::StringPrintf(<span class="string">&quot;p[%d] == %x&quot;</span>, param, args[<span class="number">0</span>]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">void</span>* match_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">        opcode-&gt;GetArgument(<span class="number">0</span>, &amp;match_ptr);</span><br><span class="line">        condition += base::StringPrintf(<span class="string">&quot;p[%d] == %p&quot;</span>, param, match_ptr);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OP_NUMBER_MATCH_RANGE:</span><br><span class="line">      opcode-&gt;GetArgument(<span class="number">0</span>, &amp;args[<span class="number">0</span>]);</span><br><span class="line">      opcode-&gt;GetArgument(<span class="number">1</span>, &amp;args[<span class="number">1</span>]);</span><br><span class="line">      condition +=</span><br><span class="line">          base::StringPrintf(<span class="string">&quot;%x &lt;= p[%d] &lt;= %x&quot;</span>, args[<span class="number">0</span>], param, args[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OP_NUMBER_AND_MATCH:</span><br><span class="line">      opcode-&gt;GetArgument(<span class="number">0</span>, &amp;args[<span class="number">0</span>]);</span><br><span class="line">      condition += base::StringPrintf(<span class="string">&quot;p[%d] &amp; %x&quot;</span>, param, args[<span class="number">0</span>]);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OP_WSTRING_MATCH: &#123;</span><br><span class="line">      <span class="keyword">int</span> pos;</span><br><span class="line">      opcode-&gt;GetArgument(<span class="number">1</span>, &amp;args[<span class="number">1</span>]);  <span class="comment">// Length.</span></span><br><span class="line">      opcode-&gt;GetArgument(<span class="number">2</span>, &amp;pos);      <span class="comment">// Position.</span></span><br><span class="line">      opcode-&gt;GetArgument(<span class="number">3</span>, &amp;args[<span class="number">3</span>]);  <span class="comment">// Options.</span></span><br><span class="line">      <span class="comment">// These are not nul-terminated so we have to wrap them here.</span></span><br><span class="line">      <span class="comment">//检索字符串参数的实际地址</span></span><br><span class="line">      <span class="keyword">auto</span> match_string = <span class="built_in">std</span>::<span class="built_in">wstring</span>(opcode-&gt;GetRelativeString(<span class="number">0</span>), <span class="number">0</span>,</span><br><span class="line">                                       <span class="keyword">static_cast</span>&lt;<span class="keyword">size_t</span>&gt;(args[<span class="number">1</span>]));</span><br><span class="line">      condition += GetStringMatchOperation(pos, args[<span class="number">3</span>]);</span><br><span class="line">      <span class="keyword">if</span> (args[<span class="number">3</span>] &amp; CASE_INSENSITIVE)  <span class="comment">// if Options = 1</span></span><br><span class="line">        condition += <span class="string">&quot;_i&quot;</span>;</span><br><span class="line">      condition +=</span><br><span class="line">          base::StringPrintf(<span class="string">&quot;(p[%d], &#x27;%S&#x27;)&quot;</span>, param, match_string.c_str());</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OP_ACTION:</span><br><span class="line">      opcode-&gt;GetArgument(<span class="number">0</span>, &amp;args[<span class="number">0</span>]);</span><br><span class="line">      condition += GetOpcodeAction(<span class="keyword">static_cast</span>&lt;EvalResult&gt;(args[<span class="number">0</span>]));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      DCHECK(<span class="literal">false</span>) &lt;&lt; <span class="string">&quot;Unknown Opcode&quot;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options &amp; kPolNegateEval)</span><br><span class="line">    condition += <span class="string">&quot;)&quot;</span>;</span><br><span class="line">  <span class="comment">// If there is another rule add a joining token.</span></span><br><span class="line">  <span class="keyword">if</span> (continuation) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options &amp; kPolUseOREval)</span><br><span class="line">      condition += <span class="string">&quot; || &quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      condition += <span class="string">&quot; &amp;&amp; &quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> condition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="GetStringMatchOperation"><a href="#GetStringMatchOperation" class="headerlink" title="GetStringMatchOperation"></a>GetStringMatchOperation</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">GetStringMatchOperation</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">uint32_t</span> options)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (pos == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options &amp; EXACT_LENGTH)</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;exact&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;prefix&quot;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;scan&quot;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos == kSeekToEnd) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ends&quot;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    DCHECK(<span class="literal">false</span>) &lt;&lt; <span class="string">&quot;Invalid pos (&quot;</span> &lt;&lt; pos &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="StringMatchOptions"><a href="#StringMatchOptions" class="headerlink" title="StringMatchOptions"></a>StringMatchOptions</h2><ul>
<li><strong>CASE_SENSITIVE = 0：</strong>Pay or Not attention to the case as defined by</li>
<li><strong>CASE_INSENSITIVE = 1：</strong>RtlCompareUnicodeString windows API.</li>
<li><strong>EXACT_LENGTH = 2：</strong>Don’t do substring match. Do full string match.</li>
</ul>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;NtCreateFile&quot;: [</span><br><span class="line">        &quot;!(p[1] &amp; 1) &amp;&amp; !(prefix(p[0], &#39;\\??\\&#39;)) -&gt; askBroker&quot;,</span><br><span class="line">        &quot;!(p[1] &amp; 1) &amp;&amp; scan(p[0], &#39;~&#39;) -&gt; askBroker&quot;,</span><br><span class="line">        &quot;prefix_i(p[0], &#39;\\??\\pipe\\chrome.&#39;) -&gt; askBroker&quot;,</span><br><span class="line">        &quot;prefix_i(p[0], &#39;\\??\\pipe\\LOCAL\\chrome.&#39;) -&gt; askBroker&quot;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>

<p>上述其实描述的是一个 opcode 组内的 opcode 的值是什么。</p>
<p><code>!(</code>：opcode 的 option 为 <code>kPolNegateEval</code></p>
<p><code>p[1] &amp; 1</code>:  <code>&amp;</code> 代表opcode 的类型为<code>OP_NUMBER_AND_MATCH</code>，原函数<code>args[1]=1</code></p>
<p><code>&amp;&amp;</code>：options 不为<code>kPolUseOREval</code></p>
<p><code>prefix</code>：String Match Options 不为<code>EXACT_LENGTH</code></p>
<p>…</p>
<p>总结：这些数据整体上描述了一个 opcode 组的内容，这个 opcode 组构成了该函数的高级缓解策略。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">0xfocu5</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://0xfocu5.github.io/posts/28399a6/">https://0xfocu5.github.io/posts/28399a6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://0xfocu5.github.io" target="_blank">Focu$ on yourself.</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Chromium/">Chromium</a></div><div class="post_share"><div class="social-share" data-image="https://focu5.oss-accelerate.aliyuncs.com/blog/20200927102719.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/42c3081f/"><img class="prev-cover" data-lazy-src="https://focu5.oss-accelerate.aliyuncs.com/blog/20200927102719.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Chromium IPC</div></div></a></div><div class="next-post pull-right"><a href="/posts/d4e8f763/"><img class="next-cover" data-lazy-src="https://focu5.oss-accelerate.aliyuncs.com/blog/20200927102719.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Chromium 基础架构</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 0xfocu5</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: 'P9GVfs1MeERE7LeK2DFsJXmn-gzGzoHsz',
      appKey: 'hzbjuPyWPjwk5HpiLPf3csE9',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/focu5.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="100" mobile="true" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/click_heart.js" async="async"></script></div></body></html>